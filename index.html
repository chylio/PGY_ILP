<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å€‹äººåŒ–å­¸ç¿’è¨ˆç•« (ILP) å¹³å°</title>

  <script>
    tailwind = { config: {} };
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: { 50:"#f0f9ff",100:"#e0f2fe",200:"#bae6fd",300:"#7dd3fc",400:"#38bdf8",500:"#0ea5e9",600:"#0284c7",700:"#0369a1",800:"#075985",900:"#0c4a6e" },
            accent:  { 50:"#f5f3ff",100:"#ede9fe",200:"#ddd6fe",300:"#c4b5fd",400:"#a78bfa",500:"#8b5cf6",600:"#7c3aed",700:"#6d28d9",800:"#5b21b6",900:"#4c1d95" },
            teal:    { 50:"#f0fdfa",100:"#ccfbf1",200:"#99f6e4",300:"#5eead4",400:"#2dd4bf",500:"#14b8a6",600:"#0d9488",700:"#0f766e",800:"#115e59",900:"#134e4a" },
            rose:    { 50:"#fff1f2",600:"#e11d48" },
            amber:   { 50:"#fffbeb",600:"#d97706" },
            emerald: { 50:"#ecfdf5",600:"#059669" }
          },
          fontFamily: { sans: ['Inter','Noto Sans TC','ui-sans-serif','system-ui','sans-serif'] },
          borderRadius: { xl: "14px" }
        }
      }
    }
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {
      background:
        radial-gradient(1200px 700px at -10% -10%, rgba(14,165,233,0.10), rgba(139,92,246,0) 60%),
        radial-gradient(1200px 700px at 110% -20%, rgba(139,92,246,0.10), rgba(14,165,233,0) 60%),
        #f7fafc;
    }
    .view { display: none; }
    .view.active { display: block; }
    .drawer { width: 360px; max-width: 90vw; }
    .modal { display:none; }
    .modal.active { display:flex; }
  </style>
</head>
<body class="font-sans text-gray-800">
  <div class="h-1 w-full bg-gradient-to-r from-primary-400 via-accent-400 to-primary-400"></div>

  <div id="app" class="min-h-screen">
    <header class="bg-white/90 backdrop-blur border-b border-slate-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-9 w-9 rounded-lg bg-primary-100 grid place-items-center text-primary-700" aria-hidden="true">ğŸ“</div>
          <h1 class="text-lg sm:text-xl font-semibold text-primary-700">ILP å­¸ç¿’å¹³å°</h1>
          <span class="hidden sm:inline ml-2 text-xs px-2 py-1 rounded-full bg-accent-50 text-accent-700 border border-accent-200">æ¸…æ–°æ•™è‚²ä¸»é¡Œ</span>
        </div>
        <div class="flex items-center gap-3">
          <span id="welcome-message" class="hidden sm:inline text-gray-600" aria-live="polite"></span>
          <button id="logout-btn" class="hidden text-sm px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 transition-colors" aria-label="ç™»å‡º">ç™»å‡º</button>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <!-- Login -->
      <div id="login-view" class="view active">
        <div class="max-w-md mx-auto">
          <section class="text-center mb-8">
            <p class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-accent-50 text-accent-700 text-sm border border-accent-200">
              <span>ğŸ“š</span> ç®¡ç†è€… / æ•™å¸« / å­¸ç”Ÿï¼ˆäººäº‹è™Ÿ/å¯†ç¢¼ï¼‰
            </p>
            <h2 class="text-2xl font-bold mt-3">å€‹äººåŒ–å­¸ç¿’è¨ˆç•«ç®¡ç†ç³»çµ±</h2>
            <p class="text-gray-500 mt-2">å­¸ç”Ÿæ¡ã€Œäººäº‹è™Ÿ + å¯†ç¢¼ã€ç™»å…¥ï¼›ç™»å…¥å¾Œè‡ªå‹•å¸¶å…¥å°å¸«ã€‚</p>
          </section>

          <div class="bg-white border border-slate-200 rounded-xl p-6">
            <form id="login-form" class="space-y-5" novalidate>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2" for="login-mode">ç™»å…¥èº«åˆ†</label>
                <select id="login-mode" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-400" aria-label="é¸æ“‡ç™»å…¥èº«åˆ†">
                  <option value="teacher">æ•™å¸«ç™»å…¥ï¼ˆäººäº‹è™Ÿ/å¯†ç¢¼ï¼‰</option>
                  <option value="student">å­¸ç”Ÿç™»å…¥ï¼ˆäººäº‹è™Ÿ/å¯†ç¢¼ï¼‰</option>
                  <option value="admin">ç®¡ç†è€…ç™»å…¥ï¼ˆäººäº‹è™Ÿ/å¯†ç¢¼ï¼‰</option>
                </select>
              </div>

              <div id="teacher-fields" class="space-y-4">
                <div>
                  <label for="teacher-login" class="block text-sm font-medium text-gray-700 mb-2">äººäº‹è™Ÿï¼ˆlogin_idï¼‰</label>
                  <input id="teacher-login" type="text" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-400" placeholder="ä¾‹å¦‚ï¼šA60833 æˆ– 940963" aria-label="äººäº‹è™Ÿ">
                </div>
                <div>
                  <label for="teacher-password" class="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                  <input id="teacher-password" type="password" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-400" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" aria-label="å¯†ç¢¼">
                </div>
              </div>

              <div id="student-fields" class="space-y-4 hidden">
                <div>
                  <label for="student-login" class="block text-sm font-medium text-gray-700 mb-2">å­¸ç”Ÿäººäº‹è™Ÿï¼ˆlogin_idï¼‰</label>
                  <input id="student-login" type="text" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-400" placeholder="ä¾‹å¦‚ï¼šB40845" aria-label="å­¸ç”Ÿäººäº‹è™Ÿ">
                </div>
                <div>
                  <label for="student-password" class="block text-sm font-medium text-gray-700 mb-2">å¯†ç¢¼</label>
                  <input id="student-password" type="password" class="w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-400" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" aria-label="å­¸ç”Ÿå¯†ç¢¼">
                  <p class="text-xs text-gray-500 mt-1">ç¤ºç¯„é è¨­ï¼šå¯†ç¢¼èˆ‡äººäº‹è™Ÿç›¸åŒï¼ˆå¯ç”¨ CSV åŒ¯å…¥ä¿®æ”¹ï¼‰ã€‚</p>
                </div>
              </div>

              <button type="submit" id="login-submit" data-cta="outline" class="w-full rounded-lg font-semibold py-2.5 transition-colors border border-primary-300" aria-label="ç™»å…¥">ç™»å…¥</button>
            </form>
          </div>
        </div>
      </div>

      <!-- App -->
      <div id="main-app-view" class="view">
        <nav id="main-nav" class="flex flex-wrap gap-2 mb-6"></nav>
        <div id="app-content"></div>
      </div>
    </main>
  </div>

  <!-- Error toast -->
  <div id="error-box" class="hidden fixed top-5 right-5 bg-rose-50 border border-rose-200 text-rose-700 px-4 py-3 rounded-lg shadow" role="alert" aria-live="assertive">
    <strong class="font-semibold">ç™¼ç”ŸéŒ¯èª¤ï¼š</strong>
    <span id="error-message" class="ml-1 align-middle"></span>
  </div>

  <!-- Drawer -->
  <div id="ai-drawer" class="hidden fixed top-0 right-0 h-full drawer bg-white border-l border-slate-200 shadow-xl z-40" aria-modal="true" role="dialog" aria-label="AI å°å¸«èˆ‡è¿½è¹¤">
    <div class="h-16 px-4 flex items-center justify-between border-b border-slate-200">
      <div class="flex items-center gap-2">
        <span class="text-primary-700" aria-hidden="true">ğŸ¤–</span>
        <h3 class="font-semibold">é‡Œç¨‹ç¢‘èˆ‡è¿½è¹¤</h3>
      </div>
      <button id="ai-drawer-close" class="p-2 rounded hover:bg-gray-100" aria-label="é—œé–‰å´æ¬„">âœ• é—œé–‰</button>
    </div>
    <div class="p-4 space-y-4 overflow-y-auto h-[calc(100%-4rem)]">
      <div class="rounded-lg bg-primary-50/60 border border-primary-100 p-3 text-sm text-primary-800">
        æé†’ï¼šAI å°å¸«æœƒåœ¨ã€Œæäº¤è¨ˆç•«ã€æ™‚è‡ªå‹•ç”¢ç”Ÿå»ºè­°ï¼›æ­¤è™•åƒ…æä¾›é‡Œç¨‹ç¢‘è¿½è¹¤ã€‚
      </div>
      <div class="border-t pt-4">
        <h4 class="font-medium mb-2">é‡Œç¨‹ç¢‘</h4>
        <div class="flex gap-2 mb-2">
          <input id="milestone-input" type="text" placeholder="è¼¸å…¥é‡Œç¨‹ç¢‘..." class="flex-1 rounded border border-gray-300 px-3 py-2" aria-label="é‡Œç¨‹ç¢‘å…§å®¹">
          <button id="milestone-add" data-cta="primary" class="px-3 py-2 rounded text-sm" aria-label="æ–°å¢é‡Œç¨‹ç¢‘">æ–°å¢</button>
        </div>
        <ul id="milestone-list" class="space-y-2"></ul>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="review-modal" class="modal fixed inset-0 bg-black/40 items-center justify-center z-50" aria-modal="true" role="dialog" aria-label="å¯©æ ¸è¦–çª—">
    <div class="bg-white max-w-[1000px] w-[95vw] max-height-[90vh] max-h-[90vh] rounded-xl shadow-xl overflow-hidden flex flex-col">
      <div class="h-14 px-5 flex items-center justify-between border-b border-slate-200">
        <div class="flex items-center gap-2">
          <span id="review-modal-icon" aria-hidden="true">ğŸ“</span>
          <h3 id="review-modal-title" class="font-semibold">å¯©æ ¸è¨ˆç•«</h3>
        </div>
        <button id="review-modal-close" class="p-2 rounded hover:bg-gray-100" aria-label="é—œé–‰å¯©æ ¸è¦–çª—">âœ• é—œé–‰</button>
      </div>
      <div id="review-modal-body" class="p-5 overflow-y-auto grow"></div>
      <div id="review-modal-footer" class="p-4 border-t border-slate-200 flex items-center justify-between">
        <div class="text-xs text-gray-500" id="review-modal-hint">æ•™å¸«å¯åœ¨æ­¤æ’°å¯«å›é¥‹ï¼Œä¸¦æ¨™è¨˜æ˜¯å¦å·²é”æˆå…±è­˜ã€‚</div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="btn-ai-for-teacher" data-cta="card" class="px-3 py-2 text-sm" aria-label="AI æ•™å¸«å›é¥‹">AIæ•™å¸«å›é¥‹</button>
          <button id="btn-submit-feedback" data-cta="card" class="px-4 py-2" aria-label="é€å‡º">é€å‡º</button>
          <button id="btn-close-modal" data-cta="card" class="px-4 py-2" aria-label="å–æ¶ˆ">å–æ¶ˆ</button>
          <button id="btn-save-feedback-draft" class="hidden"></button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // CSV defaults/templates
      const CSV_STUDENT_TEACHER_DEFAULT = `student_name,login_id,initial_password,student_class_or_level,teacher_name
é™³å»ºå»·,B40845,B40845,PGY1,éƒ­å¦ä¼¶
é«˜å“éœ“,B40831,B40831,PGY1,é™³ä¼¯æ¦•
æ—å‘å®,B40835,B40835,PGY1,éƒ­å¦ä¼¶
å³å©•å¯§,B408H2,B408H2,PGY1,é™³ä¼¯æ¦•
`;
      const CSV_ILP_FIELDS_DEFAULT = `field_key,label,type,options,required
name,å§“å,text,,TRUE
gender,æ€§åˆ¥,select,ç”·;å¥³;å…¶ä»–/ä¸é€éœ²,TRUE
rank,è·ç´š,select,é†«å­¸ç”Ÿ;PGY-1;PGY-2;ä½é™¢é†«å¸«;ç¸½é†«å¸«;ä¸»æ²»é†«å¸«;è­·ç†å¸«;å…¶ä»–,TRUE
fill_date,å¡«å¯«æ—¥æœŸ,date,,TRUE
goal,å­¸ç¿’ç›®æ¨™ä¸€ï¼ˆä½ æƒ³å­¸ä»€éº¼ï¼Ÿï¼‰,textarea,,TRUE
motivation,å­¸ç¿’å‹•æ©Ÿï¼ˆä»€éº¼äº‹ä»¶èª˜ç™¼ä½ æƒ³è¦å­¸é€™å€‹ï¼Ÿï¼‰,textarea,,TRUE
strategy,ç­–ç•¥ï¼ˆä½ éœ€è¦åšä»€éº¼ï¼Ÿï¼‰,textarea,,FALSE
resources,è³‡æºï¼ˆéœ€è¦èª°çš„å¹«å¿™æˆ–ä»€éº¼è¨­å‚™ï¼Ÿï¼‰,textarea,,FALSE
challenges,å¯èƒ½é­é‡çš„å›°é›£,textarea,,FALSE
assessment,è©•ä¼°å…§å®¹èˆ‡æŒ‡æ¨™ï¼ˆæ€éº¼æ¨£æ‰èƒ½è­‰æ˜ä½ é”åˆ°ä½ çš„å­¸ç¿’ç›®æ¨™ï¼Ÿï¼‰,textarea,,TRUE
timeline,é è¨ˆæ™‚ç¨‹ï¼ˆé€™éƒ¨åˆ†çš„å­¸ç¿’é è¨ˆå¤šä¹…é”æˆï¼Ÿï¼‰,text,,TRUE
`;
      const CSV_TEACHERS_DEFAULT = `teacher_name,login_id,initial_password
éƒ­å¦ä¼¶,940963,940963
é™³ä¼¯æ¦•,A60833,A60833
å»–å®¶å¾·,980911,980911
å³æ›‰çª,A00924,A00924
`;
      const CSV_TEACHERS_TEMPLATE = `teacher_name,login_id,initial_password
`;
      const CSV_STUDENTS_TEMPLATE = `student_name,login_id,initial_password,student_class_or_level,teacher_name
`;
      const CSV_ADMINS_TEMPLATE = `admin_name,login_id,initial_password
`;

      // DOM refs
      const loginView   = document.getElementById('login-view');
      const mainAppView = document.getElementById('main-app-view');
      const appContent  = document.getElementById('app-content');
      const mainNav     = document.getElementById('main-nav');
      const welcomeText = document.getElementById('welcome-message');
      const logoutBtn   = document.getElementById('logout-btn');

      const loginModeSel = document.getElementById('login-mode');
      const teacherFields = document.getElementById('teacher-fields');
      const studentFields = document.getElementById('student-fields');
      const studentLoginInput = document.getElementById('student-login');
      const studentPasswordInput = document.getElementById('student-password');

      const aiDrawer = document.getElementById('ai-drawer');

      const reviewModal = document.getElementById('review-modal');
      const reviewModalBody = document.getElementById('review-modal-body');
      const reviewModalTitle = document.getElementById('review-modal-title');
      const reviewModalIcon = document.getElementById('review-modal-icon');
      const reviewModalHint = document.getElementById('review-modal-hint');

      const btnAiForTeacher = document.getElementById('btn-ai-for-teacher');
      const btnSubmitFeedback = document.getElementById('btn-submit-feedback');
      const btnCloseModal = document.getElementById('btn-close-modal');
      document.getElementById('review-modal-close').addEventListener('click', closeReviewModal);

      document.getElementById('ai-drawer-close')?.addEventListener('click', closeAiDrawer);

      // STATE
      let DATA = null;
      let appState = {
        currentUser: null,
        currentView: 'login',
        currentILP: null,
        settings: {
          aiProvider:'local',
          useLocalRules:true,
          googleUrl:'https://script.google.com/macros/s/AKfycbxMKGvQHL4GZQUdE0AUGyw2nw65YAe6OqW7mD5oivdrkBZ9EXryH2F0MIjCx3qzSB58/exec',
          googleToken:''
        },
        admins: []
      };

      // Buttons styling/labels
      function applyFreshStyles(root=document) {
        const presets = {
          primary: 'bg-gradient-to-r from-primary-500 to-teal-500 text-white shadow hover:shadow-md active:scale-[0.98]',
          accent:  'bg-accent-500 text-white shadow hover:bg-accent-600 active:scale-[0.98]',
          outline: 'bg-white text-primary-700 border border-primary-200 hover:bg-primary-50 active:scale-[0.98]',
          success: 'bg-emerald-600 text-white shadow hover:bg-emerald-700 active:scale-[0.98]',
          danger:  'bg-rose-600 text-white shadow hover:bg-rose-700 active:scale-[0.98]',
          card:    'bg-white border border-slate-200 shadow-sm hover:shadow text-primary-900 active:scale-[0.98]'
        };
        root.querySelectorAll('button[data-cta]').forEach(b=>{
          const t = b.getAttribute('data-cta');
          b.classList.add('rounded-lg','transition','duration-150','px-3','py-2','font-medium');
          b.classList.remove('text-white','text-gray-700','text-primary-700','bg-white');
          (presets[t]||'').split(' ').forEach(c=> c && b.classList.add(c));
          if (t === 'outline' || t === 'card') b.style.color = '#0c4a6e';
          if (t === 'primary' || t === 'accent' || t === 'success' || t === 'danger') b.style.color = '#fff';
          if (b.id === 'login-submit') { b.setAttribute('data-cta','outline'); b.style.color = '#0c4a6e'; b.classList.add('border','border-primary-300'); }
          // ç‰¹åˆ¥è¦å‰‡ï¼šå­¸ç”Ÿã€Œå»ºç«‹/ç·¨è¼¯å­¸ç¿’è¨ˆç•«ã€çš„é€å‡ºæŒ‰éˆ•å­—é«”æ”¹ç‚ºæ·±è—è‰²ï¼ˆä¿æŒå…¶ä»–è¨­è¨ˆä¸è®Šï¼‰
          if (b.id === 'submit-ilp-btn') { b.style.color = '#0c4a6e'; }
        });
      }
      function ensureButtonLabels(root=document) {
        const map = {
          'login-submit': 'ç™»å…¥','logout-btn':'ç™»å‡º','add-new-plan-btn':'æ–°å¢è¨ˆç•«',
          'open-ai-drawer':'é‡Œç¨‹ç¢‘èˆ‡è¿½è¹¤','back-to-dashboard-btn':'è¿”å›','cancel-form-btn':'å–æ¶ˆ',
          'submit-ilp-btn':'æäº¤è¨ˆç•«','milestone-add':'æ–°å¢','btn-ai-for-teacher':'AIæ•™å¸«å›é¥‹',
          'btn-submit-feedback':'é€å‡º','btn-close-modal':'å–æ¶ˆ','ai-drawer-close':'é—œé–‰',
          'export-ilps':'åŒ¯å‡ºEXCEL','clear-storage':'æ¸…é™¤æœ¬æ©Ÿè³‡æ–™',
          'preview-import':'é è¦½é©—è­‰','apply-import':'æ–°å¢åå–®',
          'export-teachers':'åŒ¯å‡ºæ•™å¸«åå–® CSV','export-students':'åŒ¯å‡ºå­¸ç”Ÿåå–® CSV','export-mapping':'åŒ¯å‡ºå¸«ç”Ÿå°æ‡‰ CSV',
          'download-template-teachers':'ä¸‹è¼‰æ•™å¸«æ¨¡æ¿','download-template-students':'ä¸‹è¼‰å­¸ç”Ÿæ¨¡æ¿','download-template-admins':'ä¸‹è¼‰ç®¡ç†è€…æ¨¡æ¿',
          'add-admin-btn':'æ–°å¢ç®¡ç†è€…','toggle-roster-btn':'åå–®ç®¡ç†','toggle-admins-btn':'ç®¡ç†è€…å¸³è™Ÿ',
          'btn-teachers-choose-file':'åŒ¯å…¥æª”æ¡ˆ','btn-students-choose-file':'åŒ¯å…¥æª”æ¡ˆ','btn-admins-choose-file':'åŒ¯å…¥æª”æ¡ˆ',
          'apply-admins-import':'æ–°å¢åå–®','export-admins':'åŒ¯å‡ºç®¡ç†è€…åå–® CSV'
        };
        Object.entries(map).forEach(([id, text])=>{
          const el = root.getElementById ? root.getElementById(id) : null;
          if (el && (!el.innerText || !el.innerText.trim())) { el.innerText = text; el.setAttribute('aria-label', text); }
        });
        root.querySelectorAll('button[data-cta]').forEach(btn=>{
          if (!btn.innerText || !btn.innerText.trim()) {
            const alt = btn.getAttribute('aria-label') || btn.getAttribute('title') || 'æŒ‰éˆ•';
            btn.innerText = alt;
          }
        });
      }
      function hydrateButtons(scope=document){ ensureButtonLabels(scope); applyFreshStyles(scope); }
      hydrateButtons(document);
      new MutationObserver((muts)=>{ for (const m of muts){ if (m.addedNodes?.length){ hydrateButtons(document); break; } } }).observe(document.body, { childList:true, subtree:true });

      // Utils
      function showError(message) {
        const box = document.getElementById('error-box');
        const msg = document.getElementById('error-message');
        msg.textContent = message || 'ç™¼ç”ŸæœªçŸ¥çš„éŒ¯èª¤';
        box.classList.remove('hidden');
        box.classList.remove('bg-emerald-50','border-emerald-200','text-emerald-700');
        box.classList.add('bg-rose-50','border','border-rose-200','text-rose-700');
        setTimeout(() => box.classList.add('hidden'), 3600);
      }
      function showToast(msg) {
        const box = document.getElementById('error-box');
        const msgEl = document.getElementById('error-message');
        box.classList.remove('bg-rose-50','border-rose-200','text-rose-700');
        box.classList.add('bg-emerald-50','border','border-emerald-200','text-emerald-700');
        msgEl.textContent = msg || 'å®Œæˆ';
        box.classList.remove('hidden');
        setTimeout(() => {
          box.classList.add('hidden');
          box.classList.remove('bg-emerald-50','border-emerald-200','text-emerald-700');
          box.classList.add('bg-rose-50','border-rose-200','text-rose-700');
        }, 2600);
      }

      // Normalizers
      function normalizeString(s) {
        return (s==null?'':String(s))
          .replace(/\uFEFF/g,'')
          .replace(/\u3000/g,' ')
          .replace(/\s+/g,' ')
          .trim();
      }
      function parseCSV(csvText) {
        const text = (csvText||'').replace(/\r\n/g,'\n').replace(/\r/g,'\n');
        const lines = text.split('\n').filter(l => l.length>0);
        if (!lines.length) return [];
        const rawHeaders = lines[0].split(',');
        const headers = rawHeaders.map(h => normalizeString(h));
        return lines.slice(1).filter(l => normalizeString(l).length>0).map(line => {
          const values = line.match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g)?.map(v => v.replace(/^"(.*)"$/,'$1').replace(/""/g,'"')) || [];
          const obj = {};
          headers.forEach((header, index) => {
            obj[header] = normalizeString(values[index] || '');
          });
          return obj;
        });
      }
      function toCSV(rows, headers) {
        const esc = (v) => {
          const s = v==null ? '' : String(v);
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        };
        const headerLine = headers.join(',');
        const lines = rows.map(r => headers.map(h => esc(r[h])).join(','));
        return [headerLine, ...lines].join('\n');
      }
      function downloadTextFile(filename, text) {
        const blob = new Blob([text], {type:'text/csv;charset=utf-8;'});
        const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
      }
      function normalizePGY(value) {
        if (!value) return value;
        const m = String(value).match(/^PGY\s*-?\s*(\d)$/i);
        if (m) return `PGY-${m[1]}`;
        return value;
      }
      async function readFileAsTextSmart(file) {
        const buf = await file.arrayBuffer();
        const bytes = new Uint8Array(buf);
        if (bytes.length >= 2) {
          if (bytes[0] === 0xFF && bytes[1] === 0xFE) return new TextDecoder('utf-16le').decode(bytes.subarray(2));
          if (bytes[0] === 0xFE && bytes[1] === 0xFF) return new TextDecoder('utf-16be').decode(bytes.subarray(2));
        }
        if (bytes.length >= 3 && bytes[0]===0xEF && bytes[1]===0xBB && bytes[2]===0xBF) return new TextDecoder('utf-8').decode(bytes.subarray(3));
        const utf8Text = new TextDecoder('utf-8', { fatal:false }).decode(bytes);
        const badUtf8 = (utf8Text.match(/\uFFFD/g) || []).length;
        try {
          const big5Text = new TextDecoder('big5', { fatal:false }).decode(bytes);
          const badBig5 = (big5Text.match(/\uFFFD/g) || []).length;
          return badBig5 < badUtf8 ? big5Text : utf8Text;
        } catch {
          return utf8Text;
        }
      }

      // Storage keys
      const LS = {
        ilpForStudent: (name) => `ilp:${name}`,
        importedTeachersCSV: 'data:teachersCSV',
        importedStudentsCSV: 'data:studentsCSV',
        settings: 'app:settings',
        admins: 'app:admins'
      };

      // Admins
      function loadAdmins() { try { return JSON.parse(localStorage.getItem(LS.admins) || '[]') || []; } catch { return []; } }
      function saveAdmins(list) { localStorage.setItem(LS.admins, JSON.stringify(list || [])); }

      // ILP storage
      function getIlpsForStudent(studentName) { try { return JSON.parse(localStorage.getItem(LS.ilpForStudent(studentName)) || '[]') || []; } catch { return []; } }
      function saveIlpsForStudent(studentName, ilps) { localStorage.setItem(LS.ilpForStudent(studentName), JSON.stringify(ilps)); }
      function loadSettings() { try { return Object.assign(appState.settings, JSON.parse(localStorage.getItem(LS.settings) || '{}')); } catch { return appState.settings; } }
      function saveSettings(s) { localStorage.setItem(LS.settings, JSON.stringify(s)); }

      // Dataset
      function loadDataset() {
        const teachersCSV = localStorage.getItem(LS.importedTeachersCSV) || CSV_TEACHERS_DEFAULT;
        const studentsCSV = localStorage.getItem(LS.importedStudentsCSV) || CSV_STUDENT_TEACHER_DEFAULT;

        const teacherRows = parseCSV(teachersCSV);
        const studentRows = parseCSV(studentsCSV);

        const teachersById = {};
        const teachersByName = {};
        const teacherList = teacherRows.map(t => ({
          role: 'teacher', name: t.teacher_name, userId: t.login_id, password: t.initial_password
        }));
        teacherList.forEach(t => { teachersById[t.userId] = t; teachersByName[normalizeString(t.name)] = t; });

        const students = studentRows.map((s, idx) => ({
          role: 'student',
          id: `S${(idx+1).toString().padStart(4,'0')}`,
          loginId: s.login_id || '',
          password: s.initial_password || '',
          name: s.student_name,
          classLevel: s.student_class_or_level,
          teacherName: s.teacher_name
        }));
        const studentsByTeacherName = {};
        const studentsByLoginId = {};
        students.forEach(s => {
          const key = normalizeString(s.teacherName);
          if (!studentsByTeacherName[key]) studentsByTeacherName[key] = [];
          studentsByTeacherName[key].push(s);
          if (s.loginId) studentsByLoginId[s.loginId] = s;
        });
        const ilpFields = parseCSV(CSV_ILP_FIELDS_DEFAULT);

        return { teachersById, teachersByName, teacherList, students, studentsByTeacherName, studentsByLoginId, ilpFields, teachersCSV, studentsCSV };
      }

      // Backend stubs
      function backendEnabled() { return !!(appState?.settings?.googleUrl && appState?.settings?.googleToken); }
      async function backendFetch(action, payload) {
        const url = appState.settings.googleUrl;
        const token = appState.settings.googleToken;
        const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ token, action, ...payload }) });
        return res.json();
      }
      async function serverListIlps(studentName) {
        if (!backendEnabled()) return getIlpsForStudent(studentName);
        try {
          const out = await backendFetch('list_ilps_by_student', { student_name: studentName });
          if (out?.ok) {
            const remote = out.data || [];
            const local = getIlpsForStudent(studentName);
            const byId = {};
            [...local, ...remote].forEach(p=>{
              const k = p.id;
              if (!byId[k]) byId[k] = p;
              else {
                const a = new Date(byId[k].updatedAt||0).getTime();
                const b = new Date(p.updatedAt||0).getTime();
                if (b >= a) byId[k] = p;
              }
            });
            const merged = Object.values(byId);
            saveIlpsForStudent(studentName, merged);
            return merged;
          }
        } catch(e){ console.warn('serverListIlps failed', e); }
        return getIlpsForStudent(studentName);
      }
      async function serverUpsertIlp(student, ilp) { if (!backendEnabled()) return; try { await backendFetch('upsert_ilp', { student_name: student.name, ilp }); } catch(e){ console.warn('serverUpsertIlp failed', e); } }
      async function serverUpsertFeedback(student, ilp, feedback) { if (!backendEnabled()) return; try { await backendFetch('upsert_feedback', { student_name: student.name, ilp_id: ilp.id, feedback }); } catch(e){ console.warn('serverUpsertFeedback failed', e); } }

      // AI coach suggestions
      function generateAiCoachAdvice(ilp, student) {
        const f = ilp?.fields || {};
        const pgy = normalizePGY(f.rank || student.classLevel || '');
        const tips = [];

        if (f.goal && f.assessment) tips.push(`å°‡ã€Œ${f.goal.slice(0,30)}ã€å°æ‡‰åˆ°2â€“3å€‹å¯é‡åŒ–æŒ‡æ¨™ï¼Œä¸¦åœ¨æ¯æ¬¡è‡¨åºŠå¯¦ä½œå¾Œä»¥ mini-CEX ç°¡çŸ­è©•åˆ†èˆ‡åæ€ï¼ˆâ‰¤5 åˆ†é˜ï¼‰ã€‚`);
        else if (f.goal) tips.push(`ç‚ºç›®æ¨™ã€Œ${f.goal.slice(0,30)}ã€è£œä¸Šå¯é©—è­‰çš„è©•ä¼°æ–¹å¼ï¼ˆå¦‚ DOPSã€å£è©¦æˆ–ç—…ä¾‹ç°¡å ±ï¼‰ï¼Œä¸¦å®šç¾©åˆæ ¼é–€æª»ã€‚`);
        else tips.push('è«‹å…ˆæ˜ç¢ºå¯«ä¸‹æœ¬æ¬¡å­¸ç¿’ç›®æ¨™ï¼Œä¸¦ç”¨ SMART æº–å‰‡æè¿°ã€‚');

        if (f.strategy && f.resources) tips.push('æŠŠç­–ç•¥åˆ†è§£æˆæ¯é€±å…©å€‹å›ºå®šæ™‚æ®µï¼ˆä¾‹å¦‚äºŒ/å›› 17:30ï¼‰ï¼Œä¸¦äº‹å…ˆå‘å°å¸«é ç´„10åˆ†é˜è¡“å¾Œå›é¥‹ã€‚');
        else if (f.strategy || f.resources) tips.push('è£œé½Šç­–ç•¥èˆ‡è³‡æºçš„å°æ‡‰ï¼ˆèª°ã€åœ¨ä½•æ™‚æä¾›ä»€éº¼å”åŠ©ï¼‰ï¼Œæ¸›å°‘è‡¨æ™‚å°‹æ‰¾è³‡æºé€ æˆçš„å»¶èª¤ã€‚');
        else tips.push('è¦åŠƒã€Œæ–‡ç»â†’è§€æ‘©â†’æ¨¡æ“¬â†’åˆ†æ®µå¯¦ä½œâ†’åæ€ã€çš„éšæ¢¯å¼ç­–ç•¥ï¼Œä¸¦åˆ—å‡ºéœ€è¦çš„å ´åœ°/äººåŠ›ã€‚');

        if (f.challenges) tips.push('é‡å°ã€Œå¯èƒ½é­é‡çš„å›°é›£ã€å…ˆæ“¬å®šå‚™æ¡ˆï¼Œä¾‹å¦‚è§€æ‘©å ´æ¬¡ä¸è¶³æ™‚ï¼Œä»¥æ¨¡æ“¬è¨“ç·´èˆ‡éŒ„å½±å›çœ‹è£œå¼·ã€‚');
        else tips.push('è«‹é å…ˆåˆ—å‡º2é …é¢¨éšªæˆ–å›°é›£ï¼ˆå¦‚æ’ç¨‹ã€æ¡ˆä¾‹ä¸è¶³ï¼‰ï¼Œä¸¦å¯«ä¸‹å°æ‡‰å‚™æ¡ˆã€‚');

        tips.push(`ä¾ ${pgy||'ç•¶å‰'} ç­‰ç´šï¼Œå…ˆè¦æ±‚èƒ½ã€Œå£è¿°é—œéµé¢¨éšªé»ã€èˆ‡ã€Œç¤ºç¯„å®‰å…¨æª¢æŸ¥è¡¨ã€ï¼Œå†é€æ­¥é€²åˆ°åˆ†æ®µå¯¦ä½œã€‚`);

        if (f.timeline) tips.push('å°‡ç¸½æ™‚ç¨‹åˆ‡æˆæ¯é€±é‡Œç¨‹ç¢‘ï¼Œä¸¦åœ¨æ¯é€±çµæŸå‰å›å¡«é”æ¨™æƒ…æ³èˆ‡ä¸‹ä¸€æ­¥ã€‚');
        else tips.push('è«‹æè¿°é è¨ˆæ™‚ç¨‹ï¼ˆä¾‹å¦‚ 4 é€±ï¼‰ï¼Œä¸¦åœ¨æ¯é€±è¨­å®š1â€“2å€‹å¯é©—è­‰çš„å°ç›®æ¨™ã€‚');

        return tips;
      }

      function openAiDrawer() { aiDrawer.classList.remove('hidden'); }
      function closeAiDrawer() { aiDrawer.classList.add('hidden'); }

      // Progress
      const BASIC_KEYS = new Set(['name','gender','rank','fill_date']);
      function computeProgress(ilp) {
        const ms = (ilp?.progress?.milestones) || [];
        let total = ms.length;
        let done = ms.filter(m=>m.done).length;

        if (total === 0) {
          const allQs = DATA?.ilpFields || [];
          const evalQs = allQs.filter(q => !BASIC_KEYS.has(q.field_key));
          total = evalQs.length;
          const f = ilp?.fields || {};
          done = evalQs.reduce((acc, q)=>{
            const val = (f[q.field_key]||'').toString().trim();
            return acc + (val ? 1 : 0);
          }, 0);
        }

        const percent = total ? Math.round(done*100/total) : 0;
        return { total, done, percent };
      }

      // Helpers
      function sumFieldMetrics(ilp){ const m = ilp.metrics?.fields || {}; let ai=0, manual=0; Object.values(m).forEach(v=>{ ai+=(v.ai_applied||0); manual+=(v.manual_edits||0); }); return { ai, manual }; }
      function newEmptyILP(student){
        const now = new Date().toISOString().slice(0,10);
        return { id: 'ILP-' + Math.random().toString(36).slice(2,8).toUpperCase(), studentId: student.id, studentName: student.name,
          createdAt: now, updatedAt: now, status: 'è‰ç¨¿', fields: {}, progress: { percent: 0, milestones: [], ratio:{done:0,total:0} },
          aiCoach: [], teacherFeedback: [], metrics: { fields: {}, reviews: 0, lastReviewedAt: '' } };
      }
      function consensusPill(agreed) {
        return `<span class="text-xs px-2 py-1 rounded-full ${agreed?'bg-emerald-50 text-emerald-700 border border-emerald-200':'bg-gray-100 text-gray-500 border border-gray-200'}">ğŸ¤ ${agreed?'å·²å…±è­˜':'æœªå…±è­˜'}</span>`;
      }
      function countPlans(studentName) { return (getIlpsForStudent(studentName) || []).length; }
      function latestIlpOf(studentName) { const ilps = getIlpsForStudent(studentName); return ilps.length ? ilps[ilps.length-1] : null; }
      function latestUpdatedAt(studentName) {
        const ilps = getIlpsForStudent(studentName);
        if (!ilps.length) return '-';
        let latest = 0; ilps.forEach(p => { const t = new Date(p.updatedAt||p.createdAt||0).getTime(); if (t>latest) latest=t; });
        return latest ? new Date(latest).toISOString().slice(0,10) : '-';
      }

      // Router
      function navigateTo(view) {
        appState.currentView = view;
        appContent.innerHTML = '';
        updateNav();
        switch (view) {
          case 'student-dashboard': renderStudentDashboard(); break;
          case 'student-form':      renderStudentForm();      break;
          case 'teacher-dashboard': renderTeacherDashboard(); break;
          case 'admin-dashboard':   renderAdminDashboard();   break;
        }
      }
      function makeNavLink(label, view) {
        const a = document.createElement('button');
        const active = appState.currentView === view;
        a.className = [
          'px-3 py-2 rounded-lg text-sm font-medium transition-colors',
          active ? 'bg-primary-100 text-primary-800' : 'bg-white border border-slate-200 text-gray-700 hover:bg-primary-50 hover:border-primary-200'
        ].join(' ');
        a.textContent = label;
        a.setAttribute('aria-label', label);
        a.onclick = () => navigateTo(view);
        return a;
      }
      function updateNav() {
        mainNav.innerHTML = '';
        if (!appState.currentUser) { welcomeText.classList.add('hidden'); logoutBtn.classList.add('hidden'); return; }
        welcomeText.textContent = `æ­¡è¿ï¼Œ${appState.currentUser.name}`;
        welcomeText.classList.remove('hidden'); logoutBtn.classList.remove('hidden');
        const role = appState.currentUser.role;
        if (role === 'student') mainNav.appendChild(makeNavLink('æˆ‘çš„è¨ˆç•«', 'student-dashboard'));
        else if (role === 'teacher') mainNav.appendChild(makeNavLink('å­¸ç”Ÿç®¡ç†', 'teacher-dashboard'));
        else if (role === 'admin') mainNav.appendChild(makeNavLink('ç³»çµ±ç¸½è¦½', 'admin-dashboard'));
      }

      // Student dashboard
      function renderStudentDashboard() {
        const user = appState.currentUser;
        const ilps = getIlpsForStudent(user.name);

        const agg = ilps.reduce((acc, p)=>{
          const c = computeProgress(p);
          acc.done += c.done; acc.total += c.total;
          return acc;
        }, {done:0,total:0});
        const avgPercent = agg.total ? Math.round(agg.done*100/agg.total) : 0;
        const plans = countPlans(user.name);
        const aiCoachCount = ilps.reduce((a,b)=>a+(b.aiCoach?.length||0),0);

        const header = `
          <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-2 mb-6">
            <div>
              <h2 class="text-2xl font-bold">å­¸ç¿’ç¸½è¦½</h2>
              <p class="text-gray-500">å­¸ç”Ÿï¼š${user.name}ï¼ˆ${user.classLevel}ï¼‰ | å°å¸«ï¼š${user.teacherName}</p>
            </div>
            <button id="add-new-plan-btn" data-cta="card" class="font-semibold px-4 py-2" aria-label="æ–°å¢è¨ˆç•«">æ–°å¢è¨ˆç•«</button>
          </div>
        `;
        const stats = `
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
            <div class="bg-white border border-slate-200 rounded-xl p-5 flex items-center gap-4">
              <div class="h-10 w-10 rounded-lg grid place-items-center bg-primary-50 text-primary-700" aria-hidden="true">ğŸ“˜</div>
              <div><p class="text-gray-500 text-sm">å­¸ç¿’è¨ˆç•«</p><p class="text-2xl font-bold">${plans}</p></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-5 flex items-center gap-4">
              <div class="h-10 w-10 rounded-lg grid place-items-center bg-emerald-50 text-emerald-700" aria-hidden="true">ğŸ“ˆ</div>
              <div><p class="text-gray-500 text-sm">å¹³å‡å®Œæˆåº¦</p><p class="text-2xl font-bold">${avgPercent}%</p></div>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-5 flex items-center gap-4">
              <div class="h-10 w-10 rounded-lg grid place-items-center bg-amber-50 text-amber-700" aria-hidden="true">ğŸ¤–</div>
              <div><p class="text-gray-500 text-sm">AI å°å¸«å»ºè­°æ•¸</p><p class="text-2xl font-bold">${aiCoachCount}</p></div>
            </div>
          </div>
        `;
        const list = `
          <div class="bg-white border border-slate-200 rounded-xl">
            <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
              <h3 class="text-lg font-semibold">æˆ‘çš„å­¸ç¿’è¨ˆç•«</h3>
            </div>
            <ul id="ilp-list" class="divide-y divide-slate-200">
              ${ilps.length === 0 ? `<li class="px-5 py-6 text-gray-500">å°šæœªå»ºç«‹ä»»ä½•è¨ˆç•«ï¼Œé»æ“Šã€Œæ–°å¢è¨ˆç•«ã€é–‹å§‹å¡«å¯«ã€‚</li>` :
                ilps.map((ilp, idx) => {
                  const c = computeProgress(ilp);
                  return `
                <li class="px-5 py-4">
                  <div class="flex items-center justify-between gap-4">
                    <div class="min-w-0">
                      <p class="font-medium truncate">${ilp.fields?.goal?.slice(0, 40) || 'æœªå¡«å¯«ç›®æ¨™'}</p>
                      <p class="text-xs text-gray-500 mt-0.5">å»ºç«‹ï¼š${ilp.createdAt || '-'}ã€€æ›´æ–°ï¼š${ilp.updatedAt || '-'}</p>
                      <p class="text-xs text-gray-500 mt-0.5">AI å°å¸«å»ºè­°ï¼š${(ilp.aiCoach?.length||0)} å‰‡ã€€æ•™å¸«å›é¥‹ï¼š${(ilp.teacherFeedback?.length||0)} å‰‡</p>
                    </div>
                    <div class="flex items-center gap-2 shrink-0">
                      <span class="text-xs px-2 py-1 rounded bg-accent-50 text-accent-700 border border-accent-200">${ilp.status || 'è‰ç¨¿'}</span>
                      <span class="text-xs px-2 py-1 rounded bg-emerald-50 text-emerald-700">${c.total}/${c.done}ï¼ˆ${c.percent}%ï¼‰</span>
                      <button class="btn-view-plan text-xs" data-cta="outline" data-idx="${idx}" aria-label="æŸ¥çœ‹è¨ˆç•«">æŸ¥çœ‹</button>
                    </div>
                  </div>
                </li>`;
                }).join('')}
            </ul>
          </div>
        `;
        appContent.innerHTML = header + stats + list;
        hydrateButtons(appContent);
        document.getElementById('add-new-plan-btn').addEventListener('click', () => navigateTo('student-form'));
        appContent.querySelectorAll('.btn-view-plan').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const idx = Number(btn.getAttribute('data-idx'));
            const ilps2 = getIlpsForStudent(user.name);
            const ilp = ilps2[idx];
            openReviewModalForView(user, ilp);
          });
        });
      }

      // Student form
      function renderStudentForm() {
        const student = appState.currentUser;
        const fields = DATA.ilpFields;
        if (!appState.currentILP) appState.currentILP = newEmptyILP(student);

        appContent.innerHTML = `
          <div class="max-w-5xl mx-auto">
            <div class="flex items-center justify-between mb-6">
              <div>
                <h2 class="text-2xl font-bold">å»ºç«‹/ç·¨è¼¯å­¸ç¿’è¨ˆç•«</h2>
                <p class="text-gray-500">å­¸ç”Ÿï¼š${student.name}ï¼ˆ${student.classLevel}ï¼‰ï½œå°å¸«ï¼š${student.teacherName}</p>
              </div>
              <div class="flex items-center gap-2">
                <button id="back-to-dashboard-btn" class="rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2" aria-label="è¿”å›">è¿”å›</button>
              </div>
            </div>

            <form id="ilp-form" class="bg-white border border-slate-200 rounded-xl p-6 space-y-6" novalidate>
              <div class="rounded-lg bg-gradient-to-r from-primary-50 to-accent-50 text-primary-800 px-4 py-3 text-sm border border-primary-100">
                ğŸ“Œ å°æé†’ï¼šå®Œæˆå¿…å¡«æ¬„ä½å¾Œæäº¤ï¼ŒAI å°å¸«æœƒæ ¹æ“šä½ å¡«å¯«çš„å…§å®¹ï¼Œè‡ªå‹•çµ¦å‡ºå­¸ç¿’å»ºè­°ã€‚
              </div>
            </form>
          </div>
        `;
        const ilpForm = document.getElementById('ilp-form');
        const basicInfoContainer = document.createElement('div');
        basicInfoContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';

        function fieldWrapper(q) {
          const wrapper = document.createElement('div');
          const row = document.createElement('div');
          row.className = 'mb-2';
          const left = document.createElement('div'); left.textContent = q.label || q.field_key; left.className='text-sm font-medium text-gray-700';
          row.appendChild(left);
          wrapper.appendChild(row);

          let inputEl;
          if (q.type === 'select') {
            inputEl = document.createElement('select');
            inputEl.className = 'w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-400';
            (q.options || '').split(';').map(s => s.trim()).filter(Boolean).forEach(opt => {
              const option = document.createElement('option'); option.value = opt; option.textContent = opt; inputEl.appendChild(option);
            });
          } else if (q.type === 'textarea') {
            inputEl = document.createElement('textarea');
            inputEl.className = 'w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 min-h-[120px] resize-y focus:outline-none focus:ring-2 focus:ring-primary-400';
          } else if (q.type === 'date') {
            inputEl = document.createElement('input'); inputEl.type = 'date';
            inputEl.className = 'w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-400';
            if (!appState.currentILP.fields[q.field_key]) inputEl.valueAsDate = new Date();
          } else {
            inputEl = document.createElement('input'); inputEl.type = 'text';
            inputEl.className = 'w-full rounded-lg border border-gray-300 bg-white px-3 py-2.5 text-gray-800 focus:outline-none focus:ring-2 focus:ring-primary-400';
          }
          inputEl.id = q.field_key; inputEl.name = q.field_key;
          if ((String(q.required || '').toUpperCase()) === 'TRUE') inputEl.required = true;

          if (q.field_key === 'name') inputEl.value = student.name || '';
          if (q.field_key === 'rank') {
            const norm = normalizePGY(student.classLevel);
            if (q.type === 'select' && norm) {
              const opts = Array.from(inputEl.options).map(o => o.value);
              const idx = opts.indexOf(norm); if (idx >= 0) inputEl.selectedIndex = idx;
            }
          }
          if (appState.currentILP.fields[q.field_key]) inputEl.value = appState.currentILP.fields[q.field_key];

          inputEl.addEventListener('input', () => {
            appState.currentILP.fields[q.field_key] = inputEl.value;
            appState.currentILP.metrics.fields[q.field_key] = appState.currentILP.metrics.fields[q.field_key] || { ai_applied:0, manual_edits:0 };
            appState.currentILP.metrics.fields[q.field_key].manual_edits++;
            touchILP();
          });

          wrapper.appendChild(inputEl);
          return wrapper;
        }

        fields.forEach(q => {
          const w = fieldWrapper(q);
          if (['name', 'gender', 'rank', 'fill_date'].includes(q.field_key)) basicInfoContainer.appendChild(w);
          else ilpForm.appendChild(w);
        });
        ilpForm.prepend(basicInfoContainer);

        const buttons = document.createElement('div');
        buttons.className = 'flex justify-end gap-3 pt-4 border-t border-slate-200';
        buttons.innerHTML = `
          <button type="button" id="cancel-form-btn" class="rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2" aria-label="å–æ¶ˆ">å–æ¶ˆ</button>
          <button type="submit" id="submit-ilp-btn" data-cta="primary" class="rounded-lg font-semibold px-5 py-2.5" aria-label="é€å‡º">é€å‡º</button>
        `;
        ilpForm.appendChild(buttons);

        document.getElementById('back-to-dashboard-btn').addEventListener('click', () => { appState.currentILP=null; closeAiDrawer(); navigateTo('student-dashboard'); });
        document.getElementById('cancel-form-btn').addEventListener('click', () => { appState.currentILP=null; closeAiDrawer(); navigateTo('student-dashboard'); });

        ilpForm.addEventListener('submit', async (e) => {
          e.preventDefault();

          const record = {}; DATA.ilpFields.forEach(q=>{ const el=document.getElementById(q.field_key); record[q.field_key]=el?(el.value||''):''; });

          appState.currentILP.fields = record;
          appState.currentILP.status = 'æäº¤';

          const aiItems = generateAiCoachAdvice(appState.currentILP, student);
          appState.currentILP.aiCoach = appState.currentILP.aiCoach || [];
          appState.currentILP.aiCoach.push({ createdAt: new Date().toISOString(), items: aiItems });

          touchILP();

          const ilps = getIlpsForStudent(student.name);
          ilps.push(appState.currentILP);
          saveIlpsForStudent(student.name, ilps);

          await serverUpsertIlp(student, appState.currentILP);

          appState.currentILP = null;
          closeAiDrawer();
          navigateTo('student-dashboard');
        });

        hydrateButtons(appContent);

        function touchILP(){
          const c = computeProgress(appState.currentILP);
          appState.currentILP.progress.ratio = { done: c.done, total: c.total };
          appState.currentILP.progress.percent = c.percent;
          appState.currentILP.updatedAt = new Date().toISOString().slice(0,10);
        }
      }

      // Teacher dashboard
      async function renderTeacherDashboard() {
        const teacher = appState.currentUser;
        const students = DATA.studentsByTeacherName[normalizeString(teacher.name)] || [];

        if (backendEnabled() && students.length) {
          try { await Promise.all(students.map(s => serverListIlps(s.name))); } catch(e){ console.warn('prefetch failed', e); }
        }

        let totalIlps = 0, aggDone=0, aggTotal=0, pending=0;
        const staleDays = 14; const today = new Date();

        const studentRows = students.map(s => {
          const ilps = getIlpsForStudent(s.name);
          const plans = ilps.length;
          totalIlps += plans;

          ilps.forEach(p => {
            const c = computeProgress(p);
            aggDone += c.done; aggTotal += c.total;
            if ((p.status||'')!=='å·²å¯©é–±') pending++;
          });

          const latest = ilps[ilps.length-1];
          const reviewed = latest ? (latest.status === 'å·²å¯©é–±') : false;

          const opHtml = plans
            ? reviewed
              ? `<button data-stu="${s.name}" class="view-plan inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-slate-200 bg-white text-primary-900 hover:bg-slate-50 focus:outline-none focus:ring-2 focus:ring-primary-300 text-xs font-medium" aria-label="æŸ¥çœ‹">æŸ¥çœ‹</button>`
              : `<button data-stu="${s.name}" class="give-feedback inline-flex items-center gap-1 px-3 py-1.5 rounded-full border border-primary-200 bg-primary-50 text-primary-900 hover:bg-primary-100 hover:border-primary-300 focus:outline-none focus:ring-2 focus:ring-primary-300 text-xs font-medium" aria-label="çµ¦äºˆå›é¥‹">çµ¦äºˆå›é¥‹</button>`
            : `<span class="text-xs font-medium text-primary-900">ç„¡</span>`;

          return `
            <tr class="hover:bg-primary-50/50">
              <td class="py-3 px-4">${s.name}</td>
              <td class="py-3 px-4">${s.classLevel}</td>
              <td class="py-3 px-4">
                <button data-stu="${s.name}" class="btn-view-plans-count inline-flex items-center px-2 py-0.5 rounded-full text-xs border border-amber-200 bg-amber-50 text-amber-700 hover:bg-amber-100" title="æŸ¥çœ‹æ­¤å­¸ç”Ÿçš„æ‰€æœ‰è¨ˆç•«">
                  ${plans}
                </button>
              </td>
              <td class="py-3 px-4">${opHtml}</td>
            </tr>
          `;
        }).join('');
        const avgPercent = aggTotal ? Math.round(aggDone*100/aggTotal) : 0;

        const staleCount = students.reduce((acc, s)=>{
          const ilps = getIlpsForStudent(s.name);
          return acc + ilps.filter(x=>{
            const d = x.updatedAt ? Math.floor((today - new Date(x.updatedAt))/86400000) : 999;
            return d >= staleDays;
          }).length;
        }, 0);

        appContent.innerHTML = `
          <div class="flex items-end justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold">æ•™å¸«å„€è¡¨æ¿</h2>
              <p class="text-gray-500">æ•™å¸«ï¼š${teacher.name}ï¼ˆå¸³è™Ÿï¼š${teacher.userId}ï¼‰</p>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-4 mb-8">
            <div class="bg-white border border-slate-200 rounded-xl p-5"><p class="text-sm text-gray-500">å­¸ç”Ÿç¸½æ•¸</p><p class="text-3xl font-bold text-primary-700 mt-2">${students.length}</p></div>
            <div class="bg-white border border-slate-200 rounded-xl p-5"><p class="text-sm text-gray-500">å­¸ç”Ÿè¨ˆç•«æ•¸</p><p class="text-3xl font-bold text-amber-600 mt-2">${totalIlps}</p></div>
            <div class="bg-white border border-slate-200 rounded-xl p-5"><p class="text-sm text-gray-500">å¹³å‡å®Œæˆåº¦</p><p class="text-3xl font-bold text-emerald-600 mt-2">${avgPercent}%</p></div>
            <div class="bg-white border border-slate-200 rounded-xl p-5"><p class="text-sm text-gray-500">å¾…å¯©æ ¸</p><p class="text-3xl font-bold text-rose-600 mt-2">${pending}</p></div>
            <div class="bg-white border border-slate-200 rounded-xl p-5"><p class="text-sm text-gray-500">å¡é—œï¼ˆâ‰¥14å¤©ï¼‰</p><p class="text-3xl font-bold mt-2">${staleCount}</p></div>
          </div>

          <div class="bg-white border border-slate-200 rounded-xl">
            <div class="px-5 py-4 border-b border-slate-200 flex items-center justify-between">
              <h3 class="text-lg font-semibold">å­¸ç”Ÿåˆ—è¡¨</h3>
              <div class="text-sm text-gray-500">å¡é—œï¼ˆ${staleCount} ç­†ï¼šâ‰¥14å¤©æœªæ›´æ–°ï¼‰</div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead>
                  <tr class="border-b border-slate-200 text-gray-500 text-sm">
                    <th class="py-3 px-4 font-medium">å­¸ç”Ÿå§“å</th>
                    <th class="py-3 px-4 font-medium">è·ç´š/ç­ç´š</th>
                    <th class="py-3 px-4 font-medium">è¨ˆç•«æ•¸</th>
                    <th class="py-3 px-4 font-medium">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-200">
                  ${studentRows}
                </tbody>
              </table>
            </div>
          </div>
        `;
        hydrateButtons(appContent);

        // Click handlers
        appContent.querySelectorAll('.give-feedback').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const stuName = btn.getAttribute('data-stu');
            const list = getIlpsForStudent(stuName);
            if (!list.length) return;
            const latest = list[list.length-1];
            const student = DATA.students.find(x=>x.name===stuName) || { name: stuName, classLevel:'', teacherName: teacher.name };
            openReviewModalForTeacher(student, latest);
          });
        });
        appContent.querySelectorAll('.view-plan').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const stuName = btn.getAttribute('data-stu');
            const list = getIlpsForStudent(stuName);
            if (!list.length) return;
            const latest = list[list.length-1];
            const student = DATA.students.find(x=>x.name===stuName) || { name: stuName, classLevel:'', teacherName: teacher.name };
            openReviewModalForView(student, latest);
          });
        });
        // New: click plan count to view all plans of that student
        appContent.querySelectorAll('.btn-view-plans-count').forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const stuName = btn.getAttribute('data-stu');
            openTeacherPlansModal(stuName);
          });
        });
      }

      // Admin analytics + roster management (unchanged features preserved)
      function getLastNDates(n) { const arr=[]; for (let i=n-1;i>=0;i--){ const d=new Date(); d.setDate(d.getDate()-i); arr.push(d.toISOString().slice(0,10)); } return arr; }
      function collectAnalytics() {
        const aiByDay = {}; const fbByDay = {};
        const days = getLastNDates(7); days.forEach(d=>{ aiByDay[d]=0; fbByDay[d]=0; });

        let totalPlans=0, manualEdits=0, totalReviews=0;
        const completionBuckets = { '0-20':0,'20-40':0,'40-60':0,'60-80':0,'80-100':0 };

        DATA.students.forEach(s=>{
          const ilps = getIlpsForStudent(s.name);
          totalPlans += ilps.length;
          ilps.forEach(p=>{
            (p.aiCoach||[]).forEach(ac=>{
              const d = (ac.createdAt||'').slice(0,10);
              if (aiByDay[d]!=null) aiByDay[d] += 1;
            });
            (p.teacherFeedback||[]).forEach(fb=>{
              const d = (fb.createdAt||'').slice(0,10);
              if (fbByDay[d]!=null) fbByDay[d] += 1;
              totalReviews += fb.submitted ? 1 : 0;
            });
            const m = sumFieldMetrics(p); manualEdits += m.manual;
            const perc = computeProgress(p).percent;
            if (perc<20) completionBuckets['0-20']++; else if (perc<40) completionBuckets['20-40']++; else if (perc<60) completionBuckets['40-60']++; else if (perc<80) completionBuckets['60-80']++; else completionBuckets['80-100']++;
          });
        });
        return { days, aiByDay, fbByDay, completionBuckets, totalPlans, manualEdits, totalReviews };
      }
      function computeSupportReasonsForStudent(s) {
        const today = new Date();
        const p = latestIlpOf(s.name);
        if (!p) return [];
        const c = computeProgress(p);
        const upd = p.updatedAt ? new Date(p.updatedAt) : null;
        const days = upd ? Math.floor((today - upd)/86400000) : 999;
        const reasons = [];
        if (days >= 14) reasons.push('â‰¥14å¤©æœªæ›´æ–°');
        if (c.percent < 40) reasons.push('å®Œæˆåº¦ < 40%');
        if (!p.fields?.goal) reasons.push('æœªå¡«ã€Œå­¸ç¿’ç›®æ¨™ã€');
        if (!p.fields?.assessment) reasons.push('æœªå¡«ã€Œè©•ä¼°æŒ‡æ¨™ã€');
        if ((p.status||'')==='è‰ç¨¿' && days>=7) reasons.push('è‰ç¨¿è¶…é 7 å¤©æœªæäº¤');
        return reasons;
      }

      // Roster merge helper
      function mergeByKey(existingRows, newRows, key) {
        const map = {};
        (existingRows||[]).forEach(r=>{ const k=normalizeString(r[key]); if(k) map[k]=r; });
        (newRows||[]).forEach(r=>{ const k=normalizeString(r[key]); if(k) map[k]=r; });
        return Object.values(map);
      }

      function renderAdminDashboard() {
        const { days, aiByDay, fbByDay, completionBuckets, totalPlans, manualEdits, totalReviews } = collectAnalytics();

        const filterCard = `
          <div class="bg-white border border-slate-200 rounded-xl p-5 mb-6">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">å­¸å“¡ç¯©é¸èˆ‡æŸ¥çœ‹</h3>
              <div class="text-sm text-amber-700 flex items-center gap-1"><span aria-hidden="true">ğŸ””</span><span>ä»£è¡¨éœ€è¦æ”¯æ´</span></div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-3 mt-3">
              <div>
                <label class="text-sm text-gray-600 block mb-1">å°å¸«</label>
                <select id="filter-teacher" class="w-full rounded-lg border border-gray-300 px-3 py-2">
                  <option value="">å…¨éƒ¨å°å¸«</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-600 block mb-1">è·ç´š/ç­ç´š</label>
                <select id="filter-class" class="w-full rounded-lg border border-gray-300 px-3 py-2">
                  <option value="">å…¨éƒ¨</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-600 block mb-1">ç‹€æ…‹</label>
                <select id="filter-support" class="w-full rounded-lg border border-gray-300 px-3 py-2">
                  <option value="">å…¨éƒ¨å­¸å“¡</option>
                  <option value="needs">åƒ…é¡¯ç¤ºéœ€è¦æ”¯æ´</option>
                </select>
              </div>
              <div>
                <label class="text-sm text-gray-600 block mb-1">æœå°‹</label>
                <input id="filter-search" type="text" class="w-full rounded-lg border border-gray-300 px-3 py-2" placeholder="å­¸ç”Ÿå§“å / äººäº‹è™Ÿ">
              </div>
            </div>

            <div class="overflow-x-auto mt-4">
              <table class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                <thead class="bg-slate-50 text-slate-600">
                  <tr>
                    <th class="px-3 py-2 text-left">å­¸ç”Ÿå§“å</th>
                    <th class="px-3 py-2 text-left">äººäº‹è™Ÿ</th>
                    <th class="px-3 py-2 text-left">è·ç´š</th>
                    <th class="px-3 py-2 text-left">å°å¸«</th>
                    <th class="px-3 py-2 text-left">è¨ˆç•«æ•¸</th>
                    <th class="px-3 py-2 text-left">æœ€æ–°æ›´æ–°</th>
                    <th class="px-3 py-2 text-left">æé†’</th>
                    <th class="px-3 py-2 text-left">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="filter-tbody" class="divide-y"></tbody>
              </table>
            </div>
          </div>
        `;

        const manageToggles = `
          <div class="bg-white border border-slate-200 rounded-xl p-5 mb-4">
            <div class="flex items-center justify-between">
              <h3 class="text-lg font-semibold">ç®¡ç†é¢æ¿</h3>
              <p class="text-xs text-gray-500">æŒ‰ä¸‹æ–¹æŒ‰éˆ•å±•é–‹ç®¡ç†å€å¡Šï¼ˆé è¨­éš±è—ï¼‰</p>
            </div>
            <div class="mt-3 flex flex-wrap gap-2">
              <button id="toggle-roster-btn" data-cta="card" class="px-3 py-2">åå–®ç®¡ç†</button>
              <button id="toggle-admins-btn" data-cta="card" class="px-3 py-2">ç®¡ç†è€…å¸³è™Ÿ</button>
            </div>
          </div>
        `;

        const rosterCard = `
          <div id="roster-card" class="bg-white border border-slate-200 rounded-xl p-5 mt-2 hidden">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-4">
              <h3 class="text-lg font-semibold">åå–®ç®¡ç†ï¼ˆæ•™å¸« / å­¸ç”Ÿ / å¸«ç”Ÿå°æ‡‰ / ç®¡ç†è€…ï¼‰</h3>
              <div class="flex flex-wrap gap-2 items-center">
                <label class="text-sm text-gray-600">ç®¡ç†æ¸…å–®</label>
                <select id="roster-manage-select" class="rounded border border-gray-300 px-2 py-1 text-sm">
                  <option value="students">å­¸ç”Ÿåå–®</option>
                  <option value="teachers">æ•™å¸«åå–®</option>
                  <option value="admins">ç®¡ç†è€…åå–®</option>
                  <option value="mapping">å¸«ç”Ÿå°æ‡‰</option>
                </select>
                <button id="export-teachers" data-cta="outline" class="px-3 py-2">åŒ¯å‡ºæ•™å¸«åå–® CSV</button>
                <button id="export-students" data-cta="outline" class="px-3 py-2">åŒ¯å‡ºå­¸ç”Ÿåå–® CSV</button>
                <button id="export-mapping"  data-cta="outline" class="px-3 py-2">åŒ¯å‡ºå¸«ç”Ÿå°æ‡‰ CSV</button>
                <button id="export-admins"  data-cta="outline" class="px-3 py-2">åŒ¯å‡ºç®¡ç†è€…åå–® CSV</button>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Teachers -->
              <section id="section-teachers" class="space-y-2">
                <div class="flex items-center justify-between">
                  <h4 class="font-medium">æ•™å¸«åå–®ï¼ˆCSV æˆ–å–®ç­†æ–°å¢ï¼‰</h4>
                  <div class="flex items-center gap-2">
                    <button id="download-template-teachers" class="text-sm px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50">ä¸‹è¼‰æ¨¡æ¿</button>
                    <button id="btn-teachers-choose-file" data-cta="card" class="text-sm px-3 py-1.5">åŒ¯å…¥æª”æ¡ˆ</button>
                    <input id="teachers-file" type="file" accept=".csv" class="hidden">
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <input id="t-single-name"  type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="æ•™å¸«å§“å">
                  <input id="t-single-login" type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å¸³è™Ÿï¼ˆlogin_idï¼‰">
                  <input id="t-single-pass"  type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å¯†ç¢¼">
                </div>
                <div class="flex items-center gap-2">
                  <button id="t-single-add" class="text-sm px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50">åŠ å…¥åå–®</button>
                </div>
                <textarea id="csv-teachers-input" class="w-full h-40 rounded-lg border border-gray-300 px-3 py-2 text-sm" placeholder="teacher_name,login_id,initial_password&#10;ç‹å°æ˜,T001,secret"></textarea>
              </section>

              <!-- Students -->
              <section id="section-students" class="space-y-2">
                <div class="flex items-center justify-between">
                  <h4 class="font-medium">å­¸ç”Ÿåå–®ï¼ˆCSV æˆ–å–®ç­†æ–°å¢ï¼‰</h4>
                  <div class="flex items-center gap-2">
                    <button id="download-template-students" class="text-sm px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50">ä¸‹è¼‰æ¨¡æ¿</button>
                    <button id="btn-students-choose-file" data-cta="card" class="text-sm px-3 py-1.5">åŒ¯å…¥æª”æ¡ˆ</button>
                    <input id="students-file" type="file" accept=".csv" class="hidden">
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-5 gap-2">
                  <input id="s-single-name"    type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å­¸ç”Ÿå§“å">
                  <input id="s-single-login"   type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å¸³è™Ÿï¼ˆlogin_idï¼‰">
                  <input id="s-single-pass"    type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å¯†ç¢¼">
                  <input id="s-single-class"   type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="è·ç´š/ç­ç´šï¼ˆä¾‹ï¼šPGY1ï¼‰">
                  <input id="s-single-teacher" type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å°å¸«å§“å">
                </div>
                <div class="flex items-center gap-2">
                  <button id="s-single-add" class="text-sm px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50">åŠ å…¥åå–®</button>
                </div>
                <textarea id="csv-students-input" class="w-full h-40 rounded-lg border border-gray-300 px-3 py-2 text-sm" placeholder="student_name,login_id,initial_password,student_class_or_level,teacher_name&#10;å¼µå°è¯,S001,secret,PGY1,ç‹å°æ˜"></textarea>
              </section>

              <!-- Admins -->
              <section id="section-admins" class="space-y-2 lg:col-span-2">
                <div class="flex items-center justify-between">
                  <h4 class="font-medium">ç®¡ç†è€…åå–®ï¼ˆCSV æˆ–å–®ç­†æ–°å¢ï¼‰</h4>
                  <div class="flex items-center gap-2">
                    <button id="download-template-admins" class="text-sm px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50">ä¸‹è¼‰æ¨¡æ¿</button>
                    <button id="btn-admins-choose-file" data-cta="card" class="text-sm px-3 py-1.5">åŒ¯å…¥æª”æ¡ˆ</button>
                    <input id="admins-file" type="file" accept=".csv" class="hidden">
                  </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                  <input id="a-single-name"  type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="åç¨±ï¼ˆé¡¯ç¤ºç”¨ï¼‰">
                  <input id="a-single-login" type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å¸³è™Ÿï¼ˆlogin_idï¼‰">
                  <input id="a-single-pass"  type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å¯†ç¢¼">
                </div>
                <div class="flex items-center gap-2">
                  <button id="a-single-add" class="text-sm px-3 py-1.5 rounded border border-slate-200 hover:bg-slate-50">åŠ å…¥åå–®</button>
                </div>
                <textarea id="csv-admins-input" class="w-full h-32 rounded-lg border border-gray-300 px-3 py-2 text-sm" placeholder="admin_name,login_id,initial_password&#10;ç³»çµ±ç®¡ç†å“¡,ADMIN01,secret"></textarea>

                <div class="flex items-center gap-2 mt-2">
                  <button id="preview-admins-import" data-cta="outline" class="px-4 py-2">é è¦½é©—è­‰</button>
                  <button id="apply-admins-import"   data-cta="card" class="px-4 py-2">æ–°å¢åå–®</button>
                </div>
                <div id="admins-import-result" class="mt-2 hidden">
                  <div id="admins-import-summary" class="text-sm text-gray-700 mb-1"></div>
                  <ul id="admins-import-errors" class="text-sm text-rose-700 list-disc pl-5"></ul>
                </div>
              </section>
            </div>

            <!-- é è¦½èˆ‡æ–°å¢ -->
            <div class="flex flex-wrap items-center justify-between gap-2 mt-4">
              <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">é è¦½ç¯©é¸</label>
                <select id="preview-filter-teacher" class="rounded border border-gray-300 px-2 py-1 text-sm">
                  <option value="">å…¨éƒ¨å°å¸«</option>
                </select>
                <input id="preview-search" type="text" placeholder="æœå°‹å­¸ç”Ÿå§“å/äººäº‹è™Ÿ" class="rounded border border-gray-300 px-2 py-1 text-sm"/>
              </div>
              <div class="flex items-center gap-2">
                <button id="preview-import" data-cta="outline" class="px-4 py-2">é è¦½é©—è­‰</button>
                <button id="apply-import"   data-cta="card" class="px-4 py-2">æ–°å¢åå–®</button>
              </div>
            </div>

            <div id="import-result" class="mt-4 hidden">
              <div id="import-summary" class="text-sm text-gray-700 mb-2"></div>
              <ul id="import-errors" class="text-sm text-rose-700 list-disc pl-5"></ul>
              <div class="overflow-auto mt-3">
                <table id="preview-table" class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden hidden">
                  <thead class="bg-slate-50 text-slate-600">
                    <tr>
                      <th class="px-3 py-2 text-left">å­¸ç”Ÿå§“å</th>
                      <th class="px-3 py-2 text-left">äººäº‹è™Ÿ</th>
                      <th class="px-3 py-2 text-left">è·ç´š</th>
                      <th class="px-3 py-2 text-left">å°å¸«</th>
                      <th class="px-3 py-2 text-left">å°å¸«å¸³è™Ÿ</th>
                    </tr>
                  </thead>
                  <tbody id="preview-tbody" class="divide-y"></tbody>
                </table>
              </div>
            </div>
          </div>
        `;

        const adminsCard = `
          <div id="admins-card" class="bg-white border border-slate-200 rounded-xl p-5 mt-4 hidden">
            <h3 class="text-lg font-semibold mb-3">ç®¡ç†è€…å¸³è™Ÿï¼ˆå³æ™‚ç®¡ç†ï¼‰</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
              <input id="admin-name" type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="åç¨±ï¼ˆé¡¯ç¤ºç”¨ï¼Œä¾‹å¦‚ï¼šç®¡ç†è€…ï¼‰">
              <input id="admin-userid" type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="äººäº‹è™Ÿ / å¸³è™Ÿï¼ˆä¾‹å¦‚ï¼šA00924ï¼‰">
              <input id="admin-password" type="text" class="rounded-lg border border-gray-300 px-3 py-2" placeholder="å¯†ç¢¼">
            </div>
            <div class="flex items-center justify-end">
              <button id="add-admin-btn" data-cta="outline" class="px-4 py-2">æ–°å¢ç®¡ç†è€…</button>
            </div>
            <div class="overflow-x-auto mt-4">
              <table class="min-w-full text-sm border border-slate-200 rounded-lg overflow-hidden">
                <thead class="bg-slate-50 text-slate-600">
                  <tr>
                    <th class="px-3 py-2 text-left">åç¨±</th>
                    <th class="px-3 py-2 text-left">å¸³è™Ÿ</th>
                    <th class="px-3 py-2 text-left">æ“ä½œ</th>
                  </tr>
                </thead>
                <tbody id="admins-tbody" class="divide-y"></tbody>
              </table>
            </div>
            <p class="text-xs text-gray-500 mt-2">èªªæ˜ï¼šç®¡ç†è€…è³‡æ–™åƒ…å„²å­˜åœ¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚é è¨­æä¾›ä¸€çµ„ A00924 / A00924ã€‚</p>
          </div>
        `;

        appContent.innerHTML = `
          <div class="flex items-end justify-between mb-6">
            <div>
              <h2 class="text-2xl font-bold">ç®¡ç†è€…å„€è¡¨æ¿</h2>
              <p class="text-gray-500">ç®¡ç†è€…ï¼š${appState.currentUser.name}ï¼ˆå¸³è™Ÿï¼š${appState.currentUser.userId}ï¼‰</p>
            </div>
            <div class="flex gap-2">
              <button id="export-ilps" data-cta="outline" class="px-4 py-2" aria-label="åŒ¯å‡ºEXCEL">åŒ¯å‡ºEXCEL</button>
              <button id="clear-storage" data-cta="danger" class="px-4 py-2" aria-label="æ¸…é™¤æœ¬æ©Ÿè³‡æ–™">æ¸…é™¤æœ¬æ©Ÿè³‡æ–™</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-6 gap-4 mb-8">
            <div class="bg-white border border-slate-200 rounded-xl p-5 md:col-span-2"><p class="text-sm text-gray-500">æ•™å¸«æ•¸</p><p class="text-3xl font-bold text-primary-700 mt-2">${DATA.teacherList.length}</p></div>
            <div class="bg-white border border-slate-200 rounded-xl p-5 md:col-span-2"><p class="text-sm text-gray-500">å­¸ç”Ÿæ•¸</p><p class="text-3xl font-bold text-primary-700 mt-2">${DATA.students.length}</p></div>
            <div class="bg-white border border-slate-200 rounded-xl p-5 md:col-span-1"><p class="text-sm text-gray-500">è¨ˆç•«ç¸½æ•¸</p><p class="text-3xl font-bold text-amber-600 mt-2">${totalPlans}</p></div>
            <div class="bg-white border border-slate-200 rounded-xl p-5 md:col-span-1"><p class="text-sm text-gray-500">æ•™å¸«å¯©æ ¸æ¬¡æ•¸</p><p class="text-3xl font-bold text-emerald-600 mt-2">${totalReviews}</p></div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <div class="bg-white border border-slate-200 rounded-xl p-5 lg:col-span-2">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold">è¿‘ 7 æ—¥ AI å°å¸«å»ºè­°èˆ‡æ•™å¸«å›é¥‹</h3>
                <span class="text-xs text-gray-500">AI å°å¸«å»ºè­° vs æ•™å¸«å›é¥‹</span>
              </div>
              <canvas id="chart-trend" height="120" aria-label="è¿‘ä¸ƒæ—¥è¶¨å‹¢åœ–"></canvas>
            </div>
            <div class="bg-white border border-slate-200 rounded-xl p-5">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold">å®Œæˆåº¦åˆ†å¸ƒ</h3>
              </div>
              <canvas id="chart-completion" height="120" aria-label="å®Œæˆåº¦åˆ†å¸ƒåœ–"></canvas>
            </div>
          </div>

          ${filterCard}
          ${manageToggles}
          ${rosterCard}
          ${adminsCard}
        `;
        hydrateButtons(appContent);

        // Toggle cards
        document.getElementById('toggle-roster-btn')?.addEventListener('click', ()=>{
          const el = document.getElementById('roster-card');
          el.classList.toggle('hidden');
        });
        document.getElementById('toggle-admins-btn')?.addEventListener('click', ()=>{
          const el = document.getElementById('admins-card');
          el.classList.toggle('hidden');
        });

        // Admins table
        function renderAdminsTable() {
          const tbody = document.getElementById('admins-tbody');
          const rows = appState.admins.map((a, idx)=>`
            <tr>
              <td class="px-3 py-2">${a.name||'-'}</td>
              <td class="px-3 py-2">${a.userId}</td>
              <td class="px-3 py-2">
                <button class="btn-del-admin text-xs px-2 py-1 rounded border border-slate-200 hover:bg-slate-50" data-idx="${idx}">åˆªé™¤</button>
              </td>
            </tr>
          `).join('');
          tbody.innerHTML = rows || '<tr><td colspan="3" class="px-3 py-2 text-sm text-gray-500">å°šç„¡å…¶ä»–ç®¡ç†è€…ã€‚</td></tr>';
          tbody.querySelectorAll('.btn-del-admin').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const i = Number(btn.getAttribute('data-idx'));
              if (appState.admins.length <= 1) { showError('è‡³å°‘éœ€ä¿ç•™ä¸€ä½ç®¡ç†è€…'); return; }
              const uid = appState.admins[i].userId;
              if (!confirm(`ç¢ºå®šåˆªé™¤ç®¡ç†è€… ${uid}ï¼Ÿ`)) return;
              appState.admins.splice(i,1);
              saveAdmins(appState.admins);
              renderAdminsTable();
              showToast('å·²åˆªé™¤ç®¡ç†è€…');
            });
          });
        }
        renderAdminsTable();
        document.getElementById('add-admin-btn')?.addEventListener('click', ()=>{
          const name = normalizeString(document.getElementById('admin-name').value);
          const userId = normalizeString(document.getElementById('admin-userid').value);
          const password = normalizeString(document.getElementById('admin-password').value);
          if (!name || !userId || !password) { showError('è«‹å¡«å…¥åç¨±ã€å¸³è™Ÿèˆ‡å¯†ç¢¼'); return; }
          if (appState.admins.find(a=>a.userId===userId)) { showError('æ­¤å¸³è™Ÿå·²å­˜åœ¨'); return; }
          appState.admins.push({ name, userId, password, role:'admin' });
          saveAdmins(appState.admins);
          renderAdminsTable();
          showToast('å·²æ–°å¢ç®¡ç†è€…');
          document.getElementById('admin-name').value='';
          document.getElementById('admin-userid').value='';
          document.getElementById('admin-password').value='';
        });

        // Charts
        const ctx1 = document.getElementById('chart-trend');
        if (ctx1) {
          const aiData = days.map(d=>aiByDay[d]||0);
          const fbData = days.map(d=>fbByDay[d]||0);
          new Chart(ctx1, {
            type: 'line',
            data: {
              labels: days,
              datasets: [
                { label:'AI å°å¸«å»ºè­°', data: aiData, borderColor:'#0ea5e9', backgroundColor:'rgba(14,165,233,.15)', tension:.35, fill:true },
                { label:'æ•™å¸«å›é¥‹', data: fbData, borderColor:'#8b5cf6', backgroundColor:'rgba(139,92,246,.15)', tension:.35, fill:true }
              ]
            },
            options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ position:'bottom' } } }
          });
        }
        const ctx2 = document.getElementById('chart-completion');
        if (ctx2) {
          const labels = Object.keys(completionBuckets);
          new Chart(ctx2, {
            type: 'bar',
            data: {
              labels,
              datasets: [{ label:'è¨ˆç•«æ•¸', data: labels.map(k=>completionBuckets[k]), backgroundColor:'#14b8a6' }]
            },
            options: { responsive:true, scales:{ y:{ beginAtZero:true, ticks:{ precision:0 } } }, plugins:{ legend:{ display:false } } }
          });
        }

        // Filter table
        const selTeacher = document.getElementById('filter-teacher');
        const selClass = document.getElementById('filter-class');
        const selSupport = document.getElementById('filter-support');
        const inpSearch = document.getElementById('filter-search');
        const tbody = document.getElementById('filter-tbody');

        const teacherNames = Array.from(new Set(DATA.students.map(s=>normalizeString(s.teacherName)).filter(Boolean))).sort();
        selTeacher.innerHTML = `<option value="">å…¨éƒ¨å°å¸«</option>` + teacherNames.map(n => `<option>${n}</option>`).join('');
        const classes = Array.from(new Set(DATA.students.map(s=>normalizeString(s.classLevel)).filter(Boolean))).sort();
        selClass.innerHTML = `<option value="">å…¨éƒ¨</option>` + classes.map(n => `<option>${n}</option>`).join('');

        function rebuildStudentTable() {
          const t = normalizeString(selTeacher.value);
          const c = normalizeString(selClass.value);
          const sup = selSupport.value;
          const kw = inpSearch.value.trim().toLowerCase();

          let list = [...DATA.students];
          if (t) list = list.filter(s=> normalizeString(s.teacherName)===t);
          if (c) list = list.filter(s=> normalizeString(s.classLevel)===c);
          if (kw) list = list.filter(s => (s.name||'').toLowerCase().includes(kw) || (s.loginId||'').toLowerCase().includes(kw));

          const rows = list.map(s=>{
            const plans = countPlans(s.name);
            const latest = latestUpdatedAt(s.name) || '-';
            const reasons = computeSupportReasonsForStudent(s);
            if (sup==='needs' && reasons.length===0) return '';
            const bell = reasons.length ? `<span class="text-amber-600" title="${reasons.join('ã€')}" aria-label="éœ€è¦æ”¯æ´">ğŸ””</span>` : '';
            return `
              <tr class="hover:bg-primary-50/30">
                <td class="px-3 py-2">${s.name}</td>
                <td class="px-3 py-2">${s.loginId||''}</td>
                <td class="px-3 py-2">${s.classLevel||''}</td>
                <td class="px-3 py-2">${s.teacherName||''}</td>
                <td class="px-3 py-2">${plans}</td>
                <td class="px-3 py-2">${latest}</td>
                <td class="px-3 py-2">${bell}</td>
                <td class="px-3 py-2">
                  <button class="btn-view-stu text-xs px-2 py-1 rounded border border-slate-200 hover:bg-slate-50" data-stu="${s.name}">æŸ¥çœ‹å…§å®¹</button>
                </td>
              </tr>
            `;
          }).join('');
          tbody.innerHTML = rows || '<tr><td colspan="8" class="px-3 py-3 text-sm text-gray-500">ç„¡ç¬¦åˆæ¢ä»¶çš„å­¸å“¡ã€‚</td></tr>';

          tbody.querySelectorAll('.btn-view-stu').forEach(btn=>{
            btn.addEventListener('click', ()=>{
              const stuName = btn.getAttribute('data-stu');
              openStudentPlansModal(stuName);
            });
          });
        }
        [selTeacher, selClass, selSupport].forEach(el => el.addEventListener('change', rebuildStudentTable));
        inpSearch.addEventListener('input', rebuildStudentTable);
        rebuildStudentTable();

        // Roster textareas initial fill
        const taTeachers = document.getElementById('csv-teachers-input');
        const taStudents = document.getElementById('csv-students-input');
        const taAdmins   = document.getElementById('csv-admins-input');
        if (taTeachers) taTeachers.value = DATA.teachersCSV || CSV_TEACHERS_DEFAULT;
        if (taStudents) taStudents.value = DATA.studentsCSV || CSV_STUDENT_TEACHER_DEFAULT;
        if (taAdmins)   taAdmins.value   = (loadAdmins().length ? 'admin_name,login_id,initial_password\n' + loadAdmins().map(a=>`${a.name||''},${a.userId||''},${a.password||''}`).join('\n') : CSV_ADMINS_TEMPLATE);

        // File inputs
        const fileTeachers = document.getElementById('teachers-file');
        const fileStudents = document.getElementById('students-file');
        const fileAdmins   = document.getElementById('admins-file');
        document.getElementById('btn-teachers-choose-file')?.addEventListener('click', ()=> fileTeachers?.click());
        document.getElementById('btn-students-choose-file')?.addEventListener('click', ()=> fileStudents?.click());
        document.getElementById('btn-admins-choose-file')?.addEventListener('click', ()=> fileAdmins?.click());
        async function loadCsvToTextarea(fileInput, textarea, label) {
          const f = fileInput.files?.[0]; if (!f) return;
          try {
            const text = await readFileAsTextSmart(f);
            textarea.value = text;
            showToast(`å·²è¼‰å…¥${label}CSV`);
          } catch (e) {
            console.error(e);
            showError(`${label}æª”æ¡ˆè®€å–å¤±æ•—`);
          }
        }
        if (fileTeachers) fileTeachers.addEventListener('change', ()=> loadCsvToTextarea(fileTeachers, taTeachers, 'æ•™å¸«'));
        if (fileStudents) fileStudents.addEventListener('change', ()=> loadCsvToTextarea(fileStudents, taStudents, 'å­¸ç”Ÿ'));
        if (fileAdmins)   fileAdmins.addEventListener('change',   ()=> loadCsvToTextarea(fileAdmins,   taAdmins,   'ç®¡ç†è€…'));

        // Templates download
        document.getElementById('download-template-teachers')?.addEventListener('click', ()=> downloadTextFile('teachers_template.csv', CSV_TEACHERS_TEMPLATE));
        document.getElementById('download-template-students')?.addEventListener('click', ()=> downloadTextFile('students_template.csv', CSV_STUDENTS_TEMPLATE));
        document.getElementById('download-template-admins')?.addEventListener('click', ()=> downloadTextFile('admins_template.csv', CSV_ADMINS_TEMPLATE));

        // Single adds (temp)
        document.getElementById('t-single-add')?.addEventListener('click', ()=>{
          const n = normalizeString(document.getElementById('t-single-name').value);
          const l = normalizeString(document.getElementById('t-single-login').value);
          const p = normalizeString(document.getElementById('t-single-pass').value);
          if (!n || !l || !p) { showError('è«‹å®Œæ•´å¡«å¯«æ•™å¸«å§“å/å¸³è™Ÿ/å¯†ç¢¼'); return; }
          const existing = parseCSV(taTeachers.value);
          if (existing.find(r => normalizeString(r.login_id) === l)) { showError('æ•™å¸«å¸³è™Ÿå·²å­˜åœ¨æ–¼æš«å­˜åå–®'); return; }
          let base = taTeachers.value.trim();
          if (!/^teacher_name\s*,\s*login_id\s*,\s*initial_password/i.test(base)) {
            base = 'teacher_name,login_id,initial_password' + (base ? '\n'+base : '');
          }
          taTeachers.value = base + '\n' + `${n},${l},${p}`;
          document.getElementById('t-single-name').value=''; document.getElementById('t-single-login').value=''; document.getElementById('t-single-pass').value='';
          showToast('å·²åŠ å…¥æ•™å¸«åå–®ï¼ˆæš«å­˜ï¼‰');
        });

        document.getElementById('s-single-add')?.addEventListener('click', ()=>{
          const n = normalizeString(document.getElementById('s-single-name').value);
          const l = normalizeString(document.getElementById('s-single-login').value);
          const p = normalizeString(document.getElementById('s-single-pass').value);
          const c = normalizeString(document.getElementById('s-single-class').value);
          const t = normalizeString(document.getElementById('s-single-teacher').value);
          if (!n || !l || !p || !t) { showError('è«‹è‡³å°‘å¡«å¯«å­¸ç”Ÿå§“å/å¸³è™Ÿ/å¯†ç¢¼/å°å¸«'); return; }
          const tempTeachers = parseCSV(taTeachers.value).map(r=>normalizeString(r.teacher_name));
          const systemTeachers = DATA.teacherList.map(x=>normalizeString(x.name));
          const teacherSet = new Set([...tempTeachers, ...systemTeachers]);
          if (!teacherSet.has(t)) { showError(`å°å¸«ã€Œ${t}ã€ä¸å­˜åœ¨ï¼Œè«‹å…ˆåŠ å…¥æ•™å¸«åå–®æˆ–ä¿®æ­£å§“å`); return; }
          let base = taStudents.value.trim();
          if (!/^student_name\s*,\s*login_id\s*,\s*initial_password\s*,\s*student_class_or_level\s*,\s*teacher_name/i.test(base)) {
            base = 'student_name,login_id,initial_password,student_class_or_level,teacher_name' + (base ? '\n'+base : '');
          }
          taStudents.value = base + '\n' + `${n},${l},${p},${c},${t}`;
          document.getElementById('s-single-name').value=''; document.getElementById('s-single-login').value=''; document.getElementById('s-single-pass').value=''; document.getElementById('s-single-class').value=''; document.getElementById('s-single-teacher').value='';
          showToast('å·²åŠ å…¥å­¸ç”Ÿåå–®ï¼ˆæš«å­˜ï¼‰');
        });

        document.getElementById('a-single-add')?.addEventListener('click', ()=>{
          const n = normalizeString(document.getElementById('a-single-name').value);
          const l = normalizeString(document.getElementById('a-single-login').value);
          const p = normalizeString(document.getElementById('a-single-pass').value);
          if (!n || !l || !p) { showError('è«‹å®Œæ•´å¡«å¯«ç®¡ç†è€…åç¨±/å¸³è™Ÿ/å¯†ç¢¼'); return; }
          let base = taAdmins.value.trim();
          if (!/^admin_name\s*,\s*login_id\s*,\s*initial_password/i.test(base)) {
            base = 'admin_name,login_id,initial_password' + (base ? '\n'+base : '');
          }
          taAdmins.value = base + '\n' + `${n},${l},${p}`;
          document.getElementById('a-single-name').value=''; document.getElementById('a-single-login').value=''; document.getElementById('a-single-pass').value='';
          showToast('å·²åŠ å…¥ç®¡ç†è€…åå–®ï¼ˆæš«å­˜ï¼‰');
        });

        // Export CSVs
        document.getElementById('export-teachers')?.addEventListener('click', ()=>{
          const headers = ['teacher_name','login_id','initial_password'];
          const rows = DATA.teacherList.map(t => ({ teacher_name:t.name, login_id:t.userId, initial_password:t.password||'' }));
          downloadTextFile('teachers.csv', toCSV(rows, headers));
        });
        document.getElementById('export-students')?.addEventListener('click', ()=>{
          const headers = ['student_name','login_id','initial_password','student_class_or_level','teacher_name'];
          const rows = DATA.students.map(s => ({
            student_name:s.name, login_id:s.loginId, initial_password:s.password||'',
            student_class_or_level:s.classLevel||'', teacher_name:s.teacherName||''
          }));
          downloadTextFile('students.csv', toCSV(rows, headers));
        });
        document.getElementById('export-mapping')?.addEventListener('click', ()=>{
          const headers = ['teacher_name','teacher_login_id','student_name','student_login_id','student_class_or_level'];
          const rows = DATA.students.map(s => ({
            teacher_name:s.teacherName||'',
            teacher_login_id: (DATA.teachersByName[normalizeString(s.teacherName)]?.userId)||'',
            student_name:s.name, student_login_id:s.loginId, student_class_or_level:s.classLevel||''
          }));
          downloadTextFile('teacher_student_mapping.csv', toCSV(rows, headers));
        });
        document.getElementById('export-admins')?.addEventListener('click', ()=>{
          const headers = ['admin_name','login_id','initial_password'];
          const rows = appState.admins.map(a => ({ admin_name:a.name||'', login_id:a.userId||'', initial_password:a.password||'' }));
          downloadTextFile('admins.csv', toCSV(rows, headers));
        });

        // Preview import
        function validateRosterCSVs(teacherCSV, studentCSV, existingTeachersRows=[]) {
          const errors = []; const warnings = [];
          const tRows = parseCSV(teacherCSV);
          const sRows = parseCSV(studentCSV);

          if (tRows.length && !/^teacher_name\s*,\s*login_id/i.test((teacherCSV.split('\n')[0]||'').replace(/\uFEFF/g,''))) {
            warnings.push('æ•™å¸«åå–®æ¬„ä½å»ºè­°ç‚ºï¼šteacher_name,login_id,initial_password');
          }
          if (sRows.length && !/^student_name\s*,\s*login_id/i.test((studentCSV.split('\n')[0]||'').replace(/\uFEFF/g,''))) {
            warnings.push('å­¸ç”Ÿåå–®æ¬„ä½å»ºè­°ç‚ºï¼šstudent_name,login_id,initial_password,student_class_or_level,teacher_name');
          }

          const tByLogin = {}; const tNames = new Set(existingTeachersRows.map(r=>normalizeString(r.teacher_name||r.name)));
          tRows.forEach((r, idx)=>{
            const rowNum = idx+2;
            const tn = normalizeString(r.teacher_name);
            const lid = normalizeString(r.login_id);
            if (!tn) errors.push(`æ•™å¸«ç¬¬ ${rowNum} è¡Œï¼šteacher_name ä¸å¯ç©ºç™½`);
            if (!lid) errors.push(`æ•™å¸«ç¬¬ ${rowNum} è¡Œï¼šlogin_id ä¸å¯ç©ºç™½`);
            if (lid) { if (tByLogin[lid]) errors.push(`æ•™å¸« login_id é‡è¤‡ï¼š${lid}`); tByLogin[lid] = 1; }
            if (tn) tNames.add(tn);
          });

          const sByLogin = {};
          sRows.forEach((r, idx)=>{
            const rowNum = idx+2;
            const sn = normalizeString(r.student_name);
            const lid = normalizeString(r.login_id);
            const tn = normalizeString(r.teacher_name);
            if (!sn) errors.push(`å­¸ç”Ÿç¬¬ ${rowNum} è¡Œï¼šstudent_name ä¸å¯ç©ºç™½`);
            if (!lid) errors.push(`å­¸ç”Ÿç¬¬ ${rowNum} è¡Œï¼šlogin_id ä¸å¯ç©ºç™½`);
            if (!tn) errors.push(`å­¸ç”Ÿç¬¬ ${rowNum} è¡Œï¼šteacher_name ä¸å¯ç©ºç™½`);
            if (tn && !tNames.has(tn)) errors.push(`å­¸ç”Ÿç¬¬ ${rowNum} è¡Œï¼šteacher_nameã€Œ${tn}ã€ä¸åœ¨æ•™å¸«åå–®ä¸­`);
            if (lid) { if (sByLogin[lid]) errors.push(`å­¸ç”Ÿ login_id é‡è¤‡ï¼š${lid}`); sByLogin[lid] = 1; }
          });

          return { teacherRows: tRows, studentRows: sRows, errors, warnings };
        }

        let lastPreview = { teacherRows:[], studentRows:[] };
        function rebuildPreviewTable() {
          const resultBox = document.getElementById('import-result');
          const table = document.getElementById('preview-table');
          const tbodyPrev = document.getElementById('preview-tbody');
          const filter = normalizeString(document.getElementById('preview-filter-teacher').value);
          const kw = normalizeString(document.getElementById('preview-search').value).toLowerCase();
          const tByName = {}; lastPreview.teacherRows.forEach(t => { tByName[normalizeString(t.teacher_name)] = t; });

          let list = lastPreview.studentRows;
          if (filter) list = list.filter(r => normalizeString(r.teacher_name) === filter);
          if (kw) {
            list = list.filter(r => normalizeString(r.student_name).toLowerCase().includes(kw) || normalizeString(r.login_id).toLowerCase().includes(kw));
          }

          const prev = list.slice(0, 200).map(r => ({
            student_name: r.student_name, login_id: r.login_id,
            class: r.student_class_or_level, teacher: r.teacher_name,
            teacher_login: (tByName[normalizeString(r.teacher_name)]?.login_id)||''
          }));
          if (prev.length) {
            resultBox.classList.remove('hidden');
            table.classList.remove('hidden');
            tbodyPrev.innerHTML = prev.map(p=>`
              <tr>
                <td class="px-3 py-2">${p.student_name||''}</td>
                <td class="px-3 py-2">${p.login_id||''}</td>
                <td class="px-3 py-2">${p.class||''}</td>
                <td class="px-3 py-2">${p.teacher||''}</td>
                <td class="px-3 py-2">${p.teacher_login||''}</td>
              </tr>
            `).join('');
          } else {
            table.classList.add('hidden'); tbodyPrev.innerHTML = '';
          }
        }

        document.getElementById('preview-import')?.addEventListener('click', ()=>{
          const teacherCSV = (taTeachers.value||'').trim();
          const studentCSV = (taStudents.value||'').trim();
          const resultBox = document.getElementById('import-result');
          const summaryEl = document.getElementById('import-summary');
          const errorsEl = document.getElementById('import-errors');

          const existingTeacherRows = parseCSV(localStorage.getItem(LS.importedTeachersCSV)||'');
          const parsed = validateRosterCSVs(teacherCSV, studentCSV, existingTeacherRows);
          lastPreview = { teacherRows: parsed.teacherRows, studentRows: parsed.studentRows };

          resultBox.classList.remove('hidden');
          errorsEl.innerHTML = '';
          parsed.errors.forEach(e => {
            const li = document.createElement('li'); li.textContent = e; errorsEl.appendChild(li);
          });
          const warnText = parsed.warnings.length ? `ï¼›æ³¨æ„ï¼š${parsed.warnings.length} å‰‡` : '';
          summaryEl.textContent = `æ•™å¸« ${parsed.teacherRows.length} ä½ã€å­¸ç”Ÿ ${parsed.studentRows.length} ä½ã€‚éŒ¯èª¤ ${parsed.errors.length} å‰‡${warnText}`;

          const sel = document.getElementById('preview-filter-teacher');
          const names = Array.from(new Set(parsed.teacherRows.map(t=>normalizeString(t.teacher_name)).filter(Boolean))).sort();
          sel.innerHTML = `<option value="">å…¨éƒ¨å°å¸«</option>` + names.map(n=>`<option>${n}</option>`).join('');

          rebuildPreviewTable();
        });
        document.getElementById('preview-filter-teacher')?.addEventListener('change', rebuildPreviewTable);
        document.getElementById('preview-search')?.addEventListener('input', rebuildPreviewTable);

        // Apply (merge) roster
        document.getElementById('apply-import')?.addEventListener('click', ()=>{
          const teacherCSV = (taTeachers.value||'').trim();
          const studentCSV = (taStudents.value||'').trim();

          const existingTeachersRows = parseCSV(localStorage.getItem(LS.importedTeachersCSV)||'');
          const existingStudentsRows = parseCSV(localStorage.getItem(LS.importedStudentsCSV)||'');

          const { teacherRows, studentRows, errors } = validateRosterCSVs(teacherCSV, studentCSV, existingTeachersRows);
          if (errors.length) { showError('æ–°å¢åå–®å¤±æ•—ï¼šè«‹å…ˆä¿®æ­£éŒ¯èª¤ï¼Œå†é‡æ–°é è¦½/æ–°å¢ã€‚'); return; }

          const mergedTeachers = mergeByKey(existingTeachersRows, teacherRows, 'login_id');
          const teachersCSVOut = toCSV(mergedTeachers, ['teacher_name','login_id','initial_password']);
          localStorage.setItem(LS.importedTeachersCSV, teachersCSVOut || CSV_TEACHERS_TEMPLATE);

          const mergedStudents = mergeByKey(existingStudentsRows, studentRows, 'login_id');
          const studentsCSVOut = toCSV(mergedStudents, ['student_name','login_id','initial_password','student_class_or_level','teacher_name']);
          localStorage.setItem(LS.importedStudentsCSV, studentsCSVOut || CSV_STUDENTS_TEMPLATE);

          DATA = loadDataset();
          showToast('åå–®å·²æ–°å¢è‡³ç³»çµ±');
          renderAdminDashboard();
        });

        // Admins import apply
        function parseAdminsCSV(text) {
          const rows = parseCSV(text);
          const list = rows.map(r => ({
            name: r.admin_name || r.name || '',
            userId: r.login_id || r.userid || r.userId || '',
            password: r.initial_password || r.password || ''
          }));
          return list;
        }
        function validateAdminsCSV(text, existing=[]) {
          const errors = [];
          const list = parseAdminsCSV(text);
          const byId = {};
          [...existing].forEach(a=>{ if (a.userId) byId[a.userId]=1; });
          list.forEach((a, idx)=>{
            const row = idx+2;
            if (!a.name) errors.push(`ç®¡ç†è€…ç¬¬ ${row} è¡Œï¼šadmin_name ä¸å¯ç©ºç™½`);
            if (!a.userId) errors.push(`ç®¡ç†è€…ç¬¬ ${row} è¡Œï¼šlogin_id ä¸å¯ç©ºç™½`);
            if (!a.password) errors.push(`ç®¡ç†è€…ç¬¬ ${row} è¡Œï¼šinitial_password ä¸å¯ç©ºç™½`);
            if (a.userId) {
              if (byId[a.userId]) errors.push(`ç®¡ç†è€… login_id é‡è¤‡ï¼š${a.userId}`); 
              byId[a.userId] = 1;
            }
          });
          return { list, errors };
        }
        document.getElementById('preview-admins-import')?.addEventListener('click', ()=>{
          const text = (taAdmins.value||'').trim();
          const box = document.getElementById('admins-import-result');
          const sum = document.getElementById('admins-import-summary');
          const ul = document.getElementById('admins-import-errors');
          const { list, errors } = validateAdminsCSV(text, appState.admins);
          box.classList.remove('hidden');
          sum.textContent = `ç®¡ç†è€… ${list.length} ä½ã€‚éŒ¯èª¤ ${errors.length} å‰‡`;
          ul.innerHTML = errors.map(e=>`<li>${e}</li>`).join('');
        });
        document.getElementById('apply-admins-import')?.addEventListener('click', ()=>{
          const text = (taAdmins.value||'').trim();
          const { list, errors } = validateAdminsCSV(text, appState.admins);
          if (errors.length) { showError('æ–°å¢åå–®å¤±æ•—ï¼šè«‹å…ˆä¿®æ­£éŒ¯èª¤ï¼Œå†é‡æ–°é è¦½/æ–°å¢ã€‚'); return; }
          const map = {};
          (appState.admins||[]).forEach(a=>{ if (a.userId) map[a.userId]=a; });
          list.forEach(a=>{ if (a.userId) map[a.userId] = { ...a, role:'admin' }; });
          appState.admins = Object.values(map);
          saveAdmins(appState.admins);
          showToast('ç®¡ç†è€…åå–®å·²æ–°å¢è‡³ç³»çµ±');
          renderAdminDashboard();
        });

        // Export ILPs Excel
        appContent.querySelector('#export-ilps').addEventListener('click', ()=>{
          const rows = []; 
          const headers = ['student_name','teacher_name','ilp_id','createdAt','updatedAt','status','progress_percent','progress_ratio','goal','motivation','strategy','resources','challenges','assessment','timeline','ai_coach_count','manual_edits','reviews','teacher_feedback_count'];
          DATA.students.forEach(s=>{
            getIlpsForStudent(s.name).forEach(p=>{
              const m = sumFieldMetrics(p);
              const c = computeProgress(p);
              rows.push({
                student_name: s.name, teacher_name: s.teacherName, ilp_id: p.id, createdAt: p.createdAt || '', updatedAt: p.updatedAt || '', status: p.status || '',
                progress_percent: c.percent, progress_ratio: `${c.done}/${c.total}`,
                goal: p.fields?.goal || '', motivation: p.fields?.motivation || '', strategy: p.fields?.strategy || '',
                resources: p.fields?.resources || '', challenges: p.fields?.challenges || '',
                assessment: p.fields?.assessment || '', timeline: p.fields?.timeline || '',
                ai_coach_count: (p.aiCoach?.length||0), manual_edits: m.manual, reviews: p.metrics?.reviews || 0,
                teacher_feedback_count: (p.teacherFeedback?.length||0)
              });
            });
          });
          const wb = XLSX.utils.book_new();
          const ws = XLSX.utils.json_to_sheet(rows, { header: headers });
          XLSX.utils.book_append_sheet(wb, ws, 'ILPs');
          const filename = `ilps_export_${new Date().toISOString().slice(0,10)}.xlsx`;
          XLSX.writeFile(wb, filename);
        });

        // Clear local
        appContent.querySelector('#clear-storage').addEventListener('click', ()=>{
          if (!confirm('ç¢ºå®šæ¸…é™¤æœ¬æ©Ÿè³‡æ–™ï¼Ÿå°‡ç§»é™¤åŒ¯å…¥åå–®èˆ‡æ‰€æœ‰æœ¬åœ°è¨ˆç•«ã€‚')) return;
          Object.keys(localStorage).forEach(k=>{
            if (k.startsWith('ilp:') || k===LS.importedTeachersCSV || k===LS.importedStudentsCSV) localStorage.removeItem(k);
          });
          DATA = loadDataset();
          showToast('å·²æ¸…é™¤ä¸¦å›åˆ°é è¨­åå–®');
          renderAdminDashboard();
        });
      }

      // Modal helpers
      function openModal(){ reviewModal.classList.add('active','flex'); }
      function closeReviewModal(){ reviewModal.classList.remove('active','flex'); reviewModalBody.innerHTML=''; }

      function renderPlanDetails(ilp, student, readonly=false) {
        const fieldsHtml = DATA.ilpFields.map(q => `
          <div class="grid grid-cols-12 gap-3 py-2">
            <div class="col-span-4 text-sm text-gray-500">${q.label}</div>
            <div class="col-span-8 text-sm text-gray-800 whitespace-pre-wrap">${ilp.fields?.[q.field_key] || ''}</div>
          </div>
        `).join('');

        const aiCoachList = (ilp.aiCoach||[]).length
          ? ilp.aiCoach.map(ac=>`
              <li class="border border-slate-200 rounded-lg p-3 bg-white">
                <div class="text-xs text-gray-500 mb-1">${new Date(ac.createdAt||Date.now()).toLocaleString()}</div>
                <ul class="list-disc pl-5 text-sm space-y-1">${(ac.items||[]).map(x=>`<li>${x}</li>`).join('')}</ul>
              </li>`).join('')
          : '<li class="text-sm text-gray-500">å°šç„¡ AI å°å¸«å»ºè­°</li>';

        const teacherFbList = (ilp.teacherFeedback||[]).length
          ? ilp.teacherFeedback.map(fb=>`
              <li class="border border-slate-200 rounded-lg p-3 bg-white">
                <div class="flex items-center justify-between">
                  <div class="text-xs text-gray-500 mb-1">${fb.createdAt||''}ã€€å›é¥‹è€…ï¼š${fb.reviewer||''}</div>
                  ${consensusPill(!!fb.agreed)}
                </div>
                <div class="text-sm whitespace-pre-wrap"><b>æ•´é«”å›é¥‹ï¼š</b>${fb.overall||''}</div>
                ${fb.next? `<div class="text-sm whitespace-pre-wrap mt-1"><b>å»ºè­°ä¸‹ä¸€æ­¥ï¼š</b>${fb.next}</div>`:''}
              </li>`).join('')
          : '<li class="text-sm text-gray-500">å°šç„¡æ•™å¸«å›é¥‹</li>';

        const c = computeProgress(ilp);

        const editor = readonly ? '' : `
          <div class="grid grid-cols-1 gap-3">
            <div class="flex items-center justify-between">
              <label class="text-sm font-medium text-gray-700">æœ¬æ¬¡å›é¥‹</label>
              <button id="fb-agree-toggle" data-cta="outline" class="text-xs px-2 py-1 rounded border border-emerald-200 text-emerald-700" aria-label="åˆ‡æ›æ˜¯å¦å·²é”æˆå…±è­˜">ğŸ¤ æ¨™è¨˜ç‚ºå·²é”æˆå…±è­˜</button>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-700 mb-1 block">æ•´é«”å›é¥‹</label>
              <textarea id="fb-overall" class="w-full rounded-lg border border-gray-300 px-3 py-2 min-h-[100px]" aria-label="æ•´é«”å›é¥‹"></textarea>
            </div>
            <div>
              <label class="text-sm font-medium text-gray-700 mb-1 block">å»ºè­°ä¸‹ä¸€æ­¥ï¼ˆé‡Œç¨‹ç¢‘/è³‡æºï¼‰</label>
              <textarea id="fb-next" class="w-full rounded-lg border border-gray-300 px-3 py-2 min-h-[80px]" aria-label="å»ºè­°ä¸‹ä¸€æ­¥"></textarea>
            </div>
          </div>
          <div class="mt-4">
            <h5 class="text-sm font-medium text-gray-700 mb-2">æ—¢æœ‰å›é¥‹</h5>
            <ul class="space-y-2">${teacherFbList}</ul>
          </div>
        `;

        return `
          <div class="mb-4">
            <div class="text-sm text-gray-500">å­¸ç”Ÿï¼š${student.name}ï½œè·ç´šï¼š${student.classLevel||''}ï½œå°å¸«ï¼š${student.teacherName||''}</div>
            <div class="text-xs text-gray-500">å»ºç«‹ï¼š${ilp.createdAt||'-'}ã€€æ›´æ–°ï¼š${ilp.updatedAt||'-'}ã€€ç‹€æ…‹ï¼š${ilp.status||'-'}ã€€é€²åº¦ï¼š${c.total}/${c.done}ï¼ˆ${c.percent}%ï¼‰</div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <section class="bg-gradient-to-b from-white to-primary-50/40 border border-primary-100 rounded-xl p-4">
              <h4 class="font-semibold mb-3 text-primary-800">å­¸ç”Ÿè¨ˆç•«å…§å®¹</h4>
              ${fieldsHtml}
            </section>

            <section class="bg-gradient-to-b from-white to-accent-50/40 border border-accent-100 rounded-xl p-4">
              <h4 class="font-semibold mb-3 text-accent-800">AI å°å¸«å»ºè­°</h4>
              <ul class="space-y-2">${aiCoachList}</ul>
            </section>
          </div>

          <section class="bg-white border border-slate-200 rounded-xl p-4 mt-6">
            <h4 class="font-semibold mb-3">æ•™å¸«å›é¥‹</h4>
            ${readonly ? `<ul class="space-y-2">${teacherFbList}</ul>` : editor}
          </section>
        `;
      }

      // Submitting helpers
      function setSubmitting(btn, submitting, label='é€å‡º') {
        if (!btn) return;
        btn.disabled = submitting;
        btn.textContent = submitting ? 'é€å‡ºä¸­â€¦' : label;
        btn.classList.toggle('opacity-60', submitting);
        btn.classList.toggle('cursor-not-allowed', submitting);
      }

      function openReviewModalForTeacher(student, ilp) {
        document.getElementById('btn-ai-for-teacher').style.display = '';
        document.getElementById('btn-submit-feedback').style.display = '';
        document.getElementById('btn-close-modal').style.display = '';

        btnAiForTeacher.innerText = 'AIæ•™å¸«å›é¥‹';
        btnSubmitFeedback.innerText = 'é€å‡º';
        btnCloseModal.innerText = 'å–æ¶ˆ';
        btnAiForTeacher.setAttribute('data-cta','card');
        btnSubmitFeedback.setAttribute('data-cta','card');
        btnCloseModal.setAttribute('data-cta','card');
        document.getElementById('btn-save-feedback-draft').style.display = 'none';

        reviewModalIcon.textContent = 'ğŸ§‘â€ğŸ«';
        reviewModalTitle.textContent = 'å¯©æ ¸å­¸ç”Ÿè¨ˆç•«';
        reviewModalBody.innerHTML = renderPlanDetails(ilp, student, false);
        reviewModalHint.textContent = 'æ•™å¸«å¯åœ¨æ­¤æ’°å¯«å›é¥‹ï¼Œä¸¦æ¨™è¨˜æ˜¯å¦å·²é”æˆå…±è­˜ã€‚';
        hydrateButtons(reviewModal);

        let currentAgreed = false;
        const agreeBtn = reviewModalBody.querySelector('#fb-agree-toggle');
        if (agreeBtn) {
          agreeBtn.onclick = ()=>{
            currentAgreed = !currentAgreed;
            agreeBtn.textContent = currentAgreed ? 'ğŸ¤ å·²é”æˆå…±è­˜' : 'ğŸ¤ æ¨™è¨˜ç‚ºå·²é”æˆå…±è­˜';
          };
        }

        btnAiForTeacher.onclick = ()=>{
          const tips = generateAiCoachAdvice(ilp, student);
          const overall = document.getElementById('fb-overall');
          const next = document.getElementById('fb-next');
          overall.value = (overall.value? overall.value+'\n\n':'') + `å»ºè­°å›é¥‹æµç¨‹ï¼š\n- æ¯é€± 10â€“15 åˆ†é˜å›ºå®šå›é¥‹\n- ä½¿ç”¨ DOPS/mini-CEX é©—æ”¶\n- é‡å° SMART ç›®æ¨™é€é …æª¢æ ¸`;
          next.value = (next.value? next.value+'\n\n':'') + tips.join('\n');
        };

        btnSubmitFeedback.onclick = async ()=>{
          const fb = collectFeedback(true, currentAgreed);
          if (!fb) return;
          try {
            setSubmitting(btnSubmitFeedback, true);
            await persistFeedback(student, ilp, fb, true);
            showToast('å·²é€å‡ºå›é¥‹');
            closeReviewModal();
            renderTeacherDashboard();
          } catch (e) {
            console.error(e);
            showError('é€å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
          } finally {
            setSubmitting(btnSubmitFeedback, false);
          }
        };
        btnCloseModal.onclick = closeReviewModal;

        openModal();
      }

      function openReviewModalForView(student, ilp) {
        document.getElementById('btn-ai-for-teacher').style.display = 'none';
        document.getElementById('btn-save-feedback-draft').style.display = 'none';
        document.getElementById('btn-submit-feedback').style.display = 'none';

        btnCloseModal.innerText = 'é—œé–‰';
        btnCloseModal.setAttribute('data-cta','card');
        btnCloseModal.style.display = '';
        btnCloseModal.onclick = closeReviewModal;

        reviewModalIcon.textContent = 'ğŸ“„';
        reviewModalTitle.textContent = 'æŸ¥çœ‹å­¸ç¿’è¨ˆç•«èˆ‡æ•™å¸«å›é¥‹';
        reviewModalBody.innerHTML = renderPlanDetails(ilp, student, true);
        reviewModalHint.textContent = 'åƒ…ä¾›æª¢è¦–ã€‚';
        hydrateButtons(reviewModal);

        openModal();
      }

      // New: Teacher view of all plans for a student (from è¨ˆç•«æ•¸)
      function openTeacherPlansModal(stuName) {
        const teacherName = appState.currentUser?.name || '';
        const student = DATA.students.find(x=>x.name===stuName) || { name: stuName, classLevel:'', teacherName: teacherName };
        const plans = getIlpsForStudent(stuName) || [];

        reviewModalIcon.textContent = 'ğŸ“Š';
        reviewModalTitle.textContent = `å­¸ç”Ÿè¨ˆç•«æ¸…å–®ï¼š${stuName}`;
        reviewModalHint.textContent = plans.length ? 'é¸æ“‡è¨ˆç•«å¾Œå¯æŸ¥çœ‹å…§å®¹æˆ–çµ¦äºˆå›é¥‹ã€‚' : 'æ­¤å­¸å“¡å°šç„¡è¨ˆç•«ã€‚';

        if (!plans.length) {
          reviewModalBody.innerHTML = `<div class="text-sm text-gray-600">æ­¤å­¸å“¡å°šç„¡è¨ˆç•«ã€‚</div>`;
          btnAiForTeacher.style.display = 'none';
          btnSubmitFeedback.style.display = 'none';
          btnCloseModal.innerText = 'é—œé–‰';
          btnCloseModal.style.display = '';
          btnCloseModal.onclick = closeReviewModal;
          openModal();
          return;
        }

        const options = plans.map((p, idx)=>{
          const title = (p.fields?.goal?.slice(0,20) || 'æœªå¡«å¯«ç›®æ¨™');
          const status = p.status || 'è‰ç¨¿';
          return `<option value="${idx}">${p.createdAt||'-'}ï½œ${title}ï½œ${status}</option>`;
        }).join('');
        reviewModalBody.innerHTML = `
          <div class="flex flex-col gap-2 mb-3">
            <div class="flex items-center gap-2">
              <label class="text-sm text-gray-600">é¸æ“‡è¨ˆç•«</label>
              <select id="teacher-plan-select" class="rounded-lg border border-gray-300 px-2 py-1 text-sm">${options}</select>
              <span class="text-xs text-gray-500">å…± ${plans.length} ç­†</span>
            </div>
          </div>
          <div id="teacher-plan-content"></div>
        `;

        function renderSelected(idx) {
          const p = plans[idx];
          document.getElementById('teacher-plan-content').innerHTML = renderPlanDetails(p, student, true);
        }
        const planSelect = reviewModalBody.querySelector('#teacher-plan-select');
        planSelect.addEventListener('change', (e)=> renderSelected(Number(e.target.value)));
        renderSelected(0);

        // Repurpose footer buttons: æŸ¥çœ‹ / çµ¦äºˆå›é¥‹ / é—œé–‰
        btnAiForTeacher.style.display = '';
        btnSubmitFeedback.style.display = '';
        btnCloseModal.style.display = '';

        btnAiForTeacher.innerText = 'æŸ¥çœ‹';
        btnSubmitFeedback.innerText = 'çµ¦äºˆå›é¥‹';
        btnCloseModal.innerText = 'é—œé–‰';

        btnAiForTeacher.setAttribute('data-cta','card');
        btnSubmitFeedback.setAttribute('data-cta','card');
        btnCloseModal.setAttribute('data-cta','card');

        btnAiForTeacher.onclick = ()=>{
          const idx = Number(planSelect.value || 0);
          const p = plans[idx];
          openReviewModalForView(student, p);
        };
        btnSubmitFeedback.onclick = ()=>{
          const idx = Number(planSelect.value || 0);
          const p = plans[idx];
          openReviewModalForTeacher(student, p);
        };
        btnCloseModal.onclick = closeReviewModal;

        hydrateButtons(reviewModal);
        openModal();
      }

      // Admin: view student's plans (readonly)
      function openStudentPlansModal(stuName) {
        const student = DATA.students.find(x=>x.name===stuName) || { name: stuName, classLevel:'', teacherName:'' };
        const plans = getIlpsForStudent(stuName);
        reviewModalIcon.textContent = 'ğŸ“š';
        reviewModalTitle.textContent = `å­¸å“¡è¨ˆç•«ï¼š${stuName}`;
        reviewModalHint.textContent = 'ç®¡ç†è€…æª¢è¦–æ¨¡å¼ï¼Œå¯åˆ‡æ›ä¸åŒè¨ˆç•«æŸ¥çœ‹å®Œæ•´å…§å®¹èˆ‡æ•™å¸«å›é¥‹ã€‚';

        if (!plans.length) {
          reviewModalBody.innerHTML = `<div class="text-sm text-gray-600">æ­¤å­¸å“¡å°šç„¡è¨ˆç•«ã€‚</div>`;
          document.getElementById('btn-ai-for-teacher').style.display = 'none';
          document.getElementById('btn-submit-feedback').style.display = 'none';
          btnCloseModal.innerText = 'é—œé–‰';
          btnCloseModal.style.display = '';
          btnCloseModal.onclick = closeReviewModal;
          openModal();
          return;
        }

        const options = plans.map((p, idx)=>{
          const title = (p.fields?.goal?.slice(0,20) || 'æœªå¡«å¯«ç›®æ¨™');
          return `<option value="${idx}">${p.createdAt||'-'}ï½œ${title}ï½œ${p.status||'è‰ç¨¿'}</option>`;
        }).join('');
        reviewModalBody.innerHTML = `
          <div class="flex items-center gap-2 mb-3">
            <label class="text-sm text-gray-600">é¸æ“‡è¨ˆç•«</label>
            <select id="admin-plan-select" class="rounded-lg border border-gray-300 px-2 py-1 text-sm">${options}</select>
          </div>
          <div id="admin-plan-content"></div>
        `;

        function renderSelected(idx) {
          const p = plans[idx];
          document.getElementById('admin-plan-content').innerHTML = renderPlanDetails(p, student, true);
        }
        document.getElementById('admin-plan-select').addEventListener('change', (e)=> renderSelected(Number(e.target.value)));
        renderSelected(0);

        document.getElementById('btn-ai-for-teacher').style.display = 'none';
        document.getElementById('btn-submit-feedback').style.display = 'none';
        btnCloseModal.innerText = 'é—œé–‰';
        btnCloseModal.style.display = '';
        btnCloseModal.onclick = closeReviewModal;

        openModal();
      }

      function collectFeedback(submit, agreed) {
        const overall = (document.getElementById('fb-overall')?.value||'').trim();
        const next = (document.getElementById('fb-next')?.value||'').trim();
        if (!overall && !next) { showError('è«‹è‡³å°‘å¡«å¯«ä¸€é …å›é¥‹'); return null; }
        return {
          reviewer: appState.currentUser.name,
          overall, next, agreed: !!agreed,
          createdAt: new Date().toISOString().slice(0,16).replace('T',' '),
          submitted: !!submit
        };
      }
      async function persistFeedback(student, ilp, fb, submitted) {
        const list = getIlpsForStudent(student.name);
        const target = list.find(x=>x.id===ilp.id) || ilp;
        target.teacherFeedback = target.teacherFeedback || [];
        target.teacherFeedback.push(fb);
        if (submitted) {
          target.status = 'å·²å¯©é–±';
          target.metrics = target.metrics || {};
          target.metrics.reviews = (target.metrics.reviews||0) + 1;
          target.metrics.lastReviewedAt = new Date().toISOString().slice(0,10);
          target.updatedAt = target.metrics.lastReviewedAt;
        } else {
          target.updatedAt = new Date().toISOString().slice(0,10);
        }
        saveIlpsForStudent(student.name, list);
        await serverUpsertFeedback(student, target, fb);
      }

      // Login / Logout
      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const mode = loginModeSel.value;

        if (mode === 'teacher' || mode === 'admin') {
          const login = document.getElementById('teacher-login').value.trim();
          const pwd   = document.getElementById('teacher-password').value;

          if (mode === 'admin') {
            const adm = appState.admins.find(a => a.userId === login && a.password === pwd);
            if (!adm) { showError('ç®¡ç†è€…å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'); return; }
            appState.currentUser = { role: 'admin', name: adm.name || 'ç®¡ç†è€…', userId: adm.userId };
          } else {
            const teacher = DATA.teachersById[login];
            if (!teacher || teacher.password !== pwd) { showError('æ•™å¸«å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'); return; }
            appState.currentUser = { role: 'teacher', ...teacher };
          }

          loginView.classList.remove('active'); mainAppView.classList.add('active');
          updateNav(); navigateTo(appState.currentUser.role==='admin' ? 'admin-dashboard' : 'teacher-dashboard');

        } else {
          const sid = (studentLoginInput?.value || '').trim();
          const spw = (studentPasswordInput?.value || '').trim();
          if (!sid || !spw) { showError('è«‹è¼¸å…¥å­¸ç”Ÿäººäº‹è™Ÿèˆ‡å¯†ç¢¼'); return; }
          const student = DATA.studentsByLoginId[sid];
          if (!student || student.password !== spw) { showError('å­¸ç”Ÿäººäº‹è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤'); return; }
          appState.currentUser = { ...student };

          await serverListIlps(student.name);

          loginView.classList.remove('active'); mainAppView.classList.add('active');
          updateNav(); navigateTo('student-dashboard');
        }
      });

      logoutBtn.addEventListener('click', () => {
        appState.currentUser = null; appState.currentILP = null;
        closeAiDrawer(); closeReviewModal();
        mainAppView.classList.remove('active'); loginView.classList.add('active');
        welcomeText.classList.add('hidden'); welcomeText.textContent = ''; logoutBtn.classList.add('hidden');
        const tLogin = document.getElementById('teacher-login');
        const tPass = document.getElementById('teacher-password');
        if (tLogin) tLogin.value = ''; if (tPass) tPass.value = '';
        if (studentLoginInput) studentLoginInput.value=''; if (studentPasswordInput) studentPasswordInput.value='';
      });

      loginModeSel.addEventListener('change', () => {
        const mode = loginModeSel.value;
        if (mode === 'teacher' || mode === 'admin') { teacherFields.classList.remove('hidden'); studentFields.classList.add('hidden'); }
        else { teacherFields.classList.add('hidden'); studentFields.classList.remove('hidden'); }
      });

      // INIT
      appState.settings = loadSettings();
      appState.admins = loadAdmins();
      if (!appState.admins.length) {
        appState.admins = [{ name:'ç®¡ç†è€…', userId:'A00924', password:'A00924', role:'admin' }];
        saveAdmins(appState.admins);
      }
      DATA = loadDataset();
      hydrateButtons(document);
    });
  </script>
</body>
</html>
